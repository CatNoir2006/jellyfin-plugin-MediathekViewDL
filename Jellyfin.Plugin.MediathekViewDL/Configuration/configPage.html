<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <title>MediathekView Plugin Konfiguration</title>
</head>

<body>
    <div id="MediathekViewDLConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
        data-require="emby-input,emby-button,emby-select,emby-checkbox,emby-linkbutton">

        <div data-role="content">
            <div class="content-primary">

                <!-- Tab Navigation -->
                <div class="sectionTabs tabs-spacer">
                    <button type="button" class="paper-icon-button-light selected"
                        onclick="mediathekConfig.switchTab('search')">
                        <span class="material-icons search" aria-hidden="true"></span>
                        <span>Manuelle Suche</span>
                    </button>
                    <button type="button" class="paper-icon-button-light"
                        onclick="mediathekConfig.switchTab('settings')">
                        <span class="material-icons settings" aria-hidden="true"></span>
                        <span>Einstellungen</span>
                    </button>
                    <button type="button" class="paper-icon-button-light"
                        onclick="mediathekConfig.switchTab('subscriptions')">
                        <span class="material-icons subscriptions" aria-hidden="true"></span>
                        <span>Abo Verwaltung</span>
                    </button>
                </div>

                <!-- TAB 1: SUCHE -->
                <div id="tab-search" class="tab-content" style="display:block;">
                    <div class="verticalSection">
                        <div class="sectionTitleLabel">Mediathek durchsuchen</div>
                        <p class="sectionDescription">Suche nach Inhalten, um diese direkt herunterzuladen oder ein Abo
                            zu erstellen.</p>

                        <form onsubmit="mediathekConfig.performSearch(); return false;">
                            <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                                <div class="inputContainer" style="flex-grow: 1;">
                                    <label class="inputLabel" for="txtSearchQuery">Suchbegriff</label>
                                    <input is="emby-input" type="text" id="txtSearchQuery" required />
                                </div>
                                <div class="inputContainer" style="width: 150px;">
                                    <label class="inputLabel" for="numMinDuration">Min. Dauer (Sek)</label>
                                    <input is="emby-input" type="number" id="numMinDuration" />
                                </div>
                                <div class="inputContainer" style="width: 150px;">
                                    <label class="inputLabel" for="numMaxDuration">Max. Dauer (Sek)</label>
                                    <input is="emby-input" type="number" id="numMaxDuration" />
                                </div>
                                <div class="inputContainer">
                                    <button is="emby-button" type="submit" class="raised button-submit block">
                                        <span>Suchen</span>
                                    </button>
                                </div>
                            </div>
                        </form>

                        <div id="searchResults" style="margin-top: 20px;">
                            <!-- Ergebnisse werden hier gerendert -->
                        </div>
                    </div>
                </div>

                <!-- TAB 2: EINSTELLUNGEN -->
                <div id="tab-settings" class="tab-content" style="display:none;">
                    <div class="verticalSection">
                        <div class="sectionTitleLabel">Allgemeine Einstellungen</div>
                        <form id="MediathekGeneralConfigForm">

                            <div class="inputContainer">
                                <div style="display: flex; align-items: center;">
                                    <div style="flex-grow: 1;">
                                        <label class="inputLabel" for="txtDefaultDownloadPath">Standard Download
                                            Pfad</label>
                                        <input is="emby-input" type="text" id="txtDefaultDownloadPath" />
                                        <div class="fieldDescription">Der Standard-Ordner für alle Downloads, sofern im
                                            Abo nichts anderes definiert ist.</div>
                                    </div>
                                    <button type="button" is="paper-icon-button-light" id="btnSelectPath"
                                        title="Ordner auswählen" style="margin-left: 10px; margin-top: 15px;">
                                        <span class="material-icons folder_open"></span>
                                    </button>
                                </div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription" style="margin-top: 20px;">
                                <label class="emby-checkbox-label">
                                    <input id="chkDownloadSubtitles" type="checkbox" is="emby-checkbox" />
                                    <span>Untertitel herunterladen (wenn verfügbar)</span>
                                </label>
                                <div class="fieldDescription">Lädt eine separate VTT- oder TTML-Datei für Untertitel
                                    herunter, falls vom Sender bereitgestellt.</div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription" style="margin-top: 20px;">
                                <label class="emby-checkbox-label">
                                    <input id="chkAllowUnknownDomains" type="checkbox" is="emby-checkbox" />
                                    <span>Downloads von unbekannten Domains erlauben</span>
                                </label>
                                <div class="fieldDescription">Ermöglicht das Herunterladen von Inhalten von Domains, die
                                    nicht auf der Whitelist stehen. Dies kann nützlich sein, wenn ARD oder ZDF neue CDNs
                                    hinzufügen, die noch nicht berücksichtigt werden. Dies kann jedoch ein
                                    Sicherheitsrisiko darstellen, daher mit Vorsicht verwenden. Falls dadurch manche
                                    Inhalte nicht gefunden werden wäre es schon wenn auf GitHub ein Issue erstellt wird,
                                    das ich die Whitelist ggf. erweitern kann.</div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription" style="margin-top: 20px;">
                                <label class="emby-checkbox-label">
                                    <input id="chkScanLibraryAfterDownload" type="checkbox" is="emby-checkbox" />
                                    <span>Bibliotheksscan nach Download</span>
                                </label>
                                <div class="fieldDescription">Startet automatisch einen Scan der Medienbibliothek, nachdem neue Inhalte heruntergeladen wurden. Wenn deaktiviert, erscheinen neue Inhalte erst nach dem nächsten regulären Scan.</div>
                            </div>

                            <div class="inputContainer">
                                <label class="inputLabel" for="txtMinFreeDiskSpaceMiB">Mindestfreier Speicherplatz
                                    (MiB)</label>
                                <input is="emby-input" type="number" id="txtMinFreeDiskSpaceMiB" />
                                <div class="fieldDescription">Legt den minimalen freien Speicherplatz fest, der
                                    erforderlich ist, um einen neuen Download zu starten.</div>
                            </div>

                            <!-- Anzeige des letzten Laufs (Read Only) -->
                            <div class="inputContainer">
                                <label class="inputLabel">Letzter Lauf</label>
                                <div id="lblLastRun" style="padding: 10px 0;">Noch nie</div>
                            </div>

                            <div>
                                <button is="emby-button" type="submit" class="raised button-submit block">
                                    <span>Speichern</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- TAB 3: ABO VERWALTUNG -->
                <div id="tab-subscriptions" class="tab-content" style="display:none;">
                    <div class="verticalSection">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="sectionTitleLabel">Aktive Abonnements</div>
                            <button is="emby-button" type="button" class="raised"
                                onclick="subscriptionEditor.show(null)">
                                <span class="material-icons add"></span>
                                <span>Neues Abo</span>
                            </button>
                        </div>
                        <div id="subscriptionList" class="paperList" style="margin-top: 20px;">
                            <!-- Liste wird hier gerendert -->
                        </div>
                    </div>

                    <!-- Modal/Bereich zum Editieren eines Abos (Initial versteckt) -->
                    <div id="subscriptionEditor"
                        style="display: none; border-top: 1px solid #444; margin-top: 20px; padding-top: 20px;">
                        <h3 id="subEditorTitle">Abonnement bearbeiten</h3>
                        <form onsubmit="mediathekConfig.saveSubscription(); return false;">
                            <input type="hidden" id="subId" />

                            <div class="inputContainer">
                                <label class="inputLabel" for="subName">Name (Serienname)</label>
                                <input is="emby-input" type="text" id="subName" required />
                            </div>

                            <!-- Container für dynamische Queries -->
                            <div class="inputContainer">
                                <label class="inputLabel">Suchanfragen</label>
                                <div id="queriesContainer"
                                    style="display: flex; flex-direction: column; gap: 15px; margin-top: 10px;">
                                    <!-- Query-Zeilen werden hier dynamisch eingefügt -->
                                </div>
                                <button is="emby-button" type="button" class="raised"
                                    onclick="mediathekConfig.addQueryRow()" style="margin-top: 10px;">
                                    <span class="material-icons add"></span>
                                    <span>Anfrage hinzufügen</span>
                                </button>
                            </div>

                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <div class="inputContainer" style="flex-grow: 1;">
                                    <label class="inputLabel" for="subMinDuration">Min. Dauer (Minuten)</label>
                                    <input is="emby-input" type="number" id="subMinDuration" />
                                </div>
                                <div class="inputContainer" style="flex-grow: 1;">
                                    <label class="inputLabel" for="subMaxDuration">Max. Dauer (Minuten)</label>
                                    <input is="emby-input" type="number" id="subMaxDuration" />
                                </div>
                            </div>

                            <div class="inputContainer">
                                <div style="display: flex; align-items: center;">
                                    <div style="flex-grow: 1;">
                                        <label class="inputLabel" for="subPath">Download Pfad (Optional)</label>
                                        <input is="emby-input" type="text" id="subPath" />
                                        <div class="fieldDescription">Leer lassen, um den Standardpfad zu nutzen.</div>
                                    </div>
                                    <button type="button" is="paper-icon-button-light" id="btnSelectSubPath"
                                        title="Ordner auswählen" style="margin-left: 10px; margin-top: 15px;">
                                        <span class="material-icons folder_open"></span>
                                    </button>
                                </div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="subEnforceSeries" type="checkbox" is="emby-checkbox" />
                                    <span>Nur Serien herunterladen</span>
                                </label>
                                <div class="fieldDescription">Nur Videos herunterladen, die als Serie erkannt werden
                                </div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="subUseStreamingUrlFiles" type="checkbox" is="emby-checkbox" />
                                    <span>Streaming-URL-Dateien (.strm) verwenden</span>
                                </label>
                                <div class="fieldDescription">Verwendet Streaming-URL-Dateien (.strm) anstelle des
                                    Herunterladens der tatsächlichen Videodateien. Es werden keine Videodateien
                                    gespeichert, die Videos werden von ARD/ZDF direkt gestreamt. Untertitel sind hiervon nicht betroffen.</div>
                            </div>

                            <div id="subDownloadFullVideoForSecondaryAudioContainer" class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="subDownloadFullVideoForSecondaryAudio" type="checkbox" is="emby-checkbox" />
                                    <span>Vollständiges Video für sekundäre Audiosprachen herunterladen</span>
                                </label>
                                <div class="fieldDescription">Wenn aktiviert, wird das vollständige Video heruntergeladen, auch wenn es eine andere Audiosprache als Deutsch enthält. Andernfalls wird nur die Audiospur dieser Sprache extrahiert.</div>
                            </div>

                            <div id="subTreatNonEpisodesAsExtrasContainer" class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="subTreatNonEpisodesAsExtras" type="checkbox" is="emby-checkbox" />
                                    <span>Nicht Episoden als Extras behandeln</span>
                                </label>
                                <div class="fieldDescription">Nicht als Episoden erkannte Videos als Extras behandeln.
                                    Wird ignoriert, wenn "Nur Serien herunterladen" aktiviert ist.</div>
                            </div>
                            
                            <div id="subSaveExtrasAsStrmContainer" class="checkboxContainer checkboxContainer-withDescription" style="margin-left: 20px;">
                                <label class="emby-checkbox-label">
                                    <input id="subSaveExtrasAsStrm" type="checkbox" is="emby-checkbox" />
                                    <span>Extras als Stream (.strm) speichern</span>
                                </label>
                                <div class="fieldDescription">Extras werden als .strm Dateien gespeichert (spart Speicherplatz).</div>
                            </div>

                            <div id="subSaveTrailersContainer" class="checkboxContainer checkboxContainer-withDescription" style="margin-left: 20px;">
                                <label class="emby-checkbox-label">
                                    <input id="subSaveTrailers" type="checkbox" is="emby-checkbox" />
                                    <span>Trailer speichern</span>
                                </label>
                                <div class="fieldDescription">Trailer werden gespeichert.</div>
                            </div>

                            <div id="subSaveInterviewsContainer" class="checkboxContainer checkboxContainer-withDescription" style="margin-left: 20px;">
                                <label class="emby-checkbox-label">
                                    <input id="subSaveInterviews" type="checkbox" is="emby-checkbox" />
                                    <span>Interviews speichern</span>
                                </label>
                                <div class="fieldDescription">Interviews werden gespeichert.</div>
                            </div>

                            <div id="subSaveGenericExtrasContainer" class="checkboxContainer checkboxContainer-withDescription" style="margin-left: 20px;">
                                <label class="emby-checkbox-label">
                                    <input id="subSaveGenericExtras" type="checkbox" is="emby-checkbox" />
                                    <span>Generische Extras speichern</span>
                                </label>
                                <div class="fieldDescription">Alle anderen Extras (nicht Trailer/Interviews) werden gespeichert.</div>
                            </div>

                            <div id="subAllowAbsoluteEpisodeNumberingContainer" class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="subAllowAbsoluteEpisodeNumbering" type="checkbox" is="emby-checkbox" />
                                    <span>Absolute Episodennummerierung erlauben</span>
                                </label>
                                <div class="fieldDescription">Episoden auch herunterladen wenn nur Absolute
                                    Episodennummerierung vorliegt (z.B. "Episode 5" statt "Staffel 1, Episode 5"). Wird
                                    nur berücksichtigt, wenn "Nur Videos herunterladen, die als Serie erkannt werden"
                                    aktiviert ist.</div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="subAllowAudioDesc" type="checkbox" is="emby-checkbox" />
                                    <span>Versionen mit Audiodeskription erlauben</span>
                                </label>
                                <div class="fieldDescription">Erlaubt das Herunterladen von Versionen mit
                                    Audiodeskription (sofern verfügbar).</div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="subAllowSignLanguage" type="checkbox" is="emby-checkbox" />
                                    <span>Versionen mit Gebärdensprache erlauben</span>
                                </label>
                                <div class="fieldDescription">Erlaubt das Herunterladen von Versionen mit
                                    Gebärdensprache (sofern verfügbar).</div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="subEnhancedDuplicateDetection" type="checkbox" is="emby-checkbox" />
                                    <span>Erweiterte Duplikaterkennung</span>
                                </label>
                                <div class="fieldDescription">Scannt das Zielverzeichnis nach vorhandenen Dateien mit passenden SxxExx-Mustern (oder absoluter Nummerierung), um doppelte Downloads zu vermeiden (auch bei abweichenden Dateinamen).</div>
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <button is="emby-button" type="submit" class="raised button-submit">
                                    <span>Abo Speichern</span>
                                </button>
                                <button is="emby-button" type="button" class="raised button-cancel"
                                    onclick="subscriptionEditor.close()">
                                    <span>Abbrechen</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
        </div>

        <div id="advancedDownloadModal" class="dialog-host"
            style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
            <div class="dialog-content"
                style="background-color: #303030; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 5px;">
                <h2 id="advancedDownloadTitle">Erweiterter Download</h2>
                <form onsubmit="mediathekConfig.performAdvancedDownload(); return false;">
                    <input type="hidden" id="advancedDownloadIndex" />

                    <div class="inputContainer">
                        <div style="display: flex; align-items: center;">
                            <div style="flex-grow: 1;">
                                <label class="inputLabel" for="advDlPath">Download Pfad</label>
                                <input is="emby-input" type="text" id="advDlPath" />
                            </div>
                            <button type="button" is="paper-icon-button-light" id="btnSelectAdvPath"
                                title="Ordner auswählen" style="margin-left: 10px; margin-top: 15px;">
                                <span class="material-icons folder_open"></span>
                            </button>
                        </div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="advDlFilename">Dateiname</label>
                        <input is="emby-input" type="text" id="advDlFilename" />
                    </div>

                    <div class="checkboxContainer">
                        <label class="emby-checkbox-label">
                            <input id="advDlSubtitles" type="checkbox" is="emby-checkbox" />
                            <span>Untertitel herunterladen</span>
                        </label>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button is="emby-button" type="submit" class="raised button-submit">
                            <span>Herunterladen</span>
                        </button>
                        <button is="emby-button" type="button" class="raised button-cancel"
                            onclick="mediathekConfig.closeAdvancedDownloadDialog()">
                            <span>Abbrechen</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            class SubscriptionEditor {
                constructor(configInstance) {
                    this.config = configInstance;
                }

                setEditorValues(sub) {
                    if (!sub) {
                        // Reset values
                        document.getElementById('subId').value = "";
                        document.getElementById('subName').value = "";
                        document.getElementById('subMinDuration').value = "";
                        document.getElementById('subMaxDuration').value = "";
                        document.getElementById('subPath').value = "";

                        document.getElementById('subEnforceSeries').checked = false;
                        document.getElementById('subAllowAudioDesc').checked = false;
                        document.getElementById('subAllowAbsoluteEpisodeNumbering').checked = false;
                        document.getElementById('subAllowSignLanguage').checked = false;
                        document.getElementById('subTreatNonEpisodesAsExtras').checked = false;
                        document.getElementById('subSaveTrailers').checked = true;
                        document.getElementById('subSaveInterviews').checked = true;
                        document.getElementById('subSaveGenericExtras').checked = true;
                        document.getElementById('subSaveExtrasAsStrm').checked = false;
                        document.getElementById('subUseStreamingUrlFiles').checked = false;
                        document.getElementById('subDownloadFullVideoForSecondaryAudio').checked = false;
                        document.getElementById('subEnhancedDuplicateDetection').checked = false;

                        document.getElementById('queriesContainer').textContent = '';
                        this.config.addQueryRow(null);
                        return;
                    }

                    document.getElementById('subId').value = sub.Id || "";
                    document.getElementById('subName').value = sub.Name;
                    document.getElementById('subMinDuration').value = sub.MinDurationMinutes || "";
                    document.getElementById('subMaxDuration').value = sub.MaxDurationMinutes || "";
                    document.getElementById('subPath').value = sub.DownloadPath || "";
                    document.getElementById('subEnforceSeries').checked = sub.EnforceSeriesParsing;
                    document.getElementById('subAllowAudioDesc').checked = sub.AllowAudioDescription;
                    document.getElementById('subAllowAbsoluteEpisodeNumbering').checked = sub.AllowAbsoluteEpisodeNumbering;
                    document.getElementById('subAllowSignLanguage').checked = sub.AllowSignLanguage;
                    document.getElementById('subEnhancedDuplicateDetection').checked = sub.EnhancedDuplicateDetection;
                    document.getElementById('subTreatNonEpisodesAsExtras').checked = sub.TreatNonEpisodesAsExtras;
                    document.getElementById('subSaveTrailers').checked = sub.SaveTrailers;
                    document.getElementById('subSaveInterviews').checked = sub.SaveInterviews;
                    document.getElementById('subSaveGenericExtras').checked = sub.SaveGenericExtras;
                    document.getElementById('subSaveExtrasAsStrm').checked = sub.SaveExtrasAsStrm;
                    document.getElementById('subUseStreamingUrlFiles').checked = sub.UseStreamingUrlFiles;
                    document.getElementById('subDownloadFullVideoForSecondaryAudio').checked = sub.DownloadFullVideoForSecondaryAudio;

                    const queriesContainer = document.getElementById('queriesContainer');
                    queriesContainer.textContent = '';
                    if (sub.Queries && sub.Queries.length > 0) {
                        sub.Queries.forEach((q) => { this.config.addQueryRow(q); });
                    } else {
                        this.config.addQueryRow(null);
                    }
                }

                getEditorValues() {
                    const id = document.getElementById('subId').value;
                    const name = document.getElementById('subName').value;
                    const minDuration = document.getElementById('subMinDuration').value;
                    const maxDuration = document.getElementById('subMaxDuration').value;
                    const path = document.getElementById('subPath').value;
                    const enforce = document.getElementById('subEnforceSeries').checked;
                    const allowAudio = document.getElementById('subAllowAudioDesc').checked;
                    const allowAbsolute = document.getElementById('subAllowAbsoluteEpisodeNumbering').checked;
                    const allowSignLanguage = document.getElementById('subAllowSignLanguage').checked;
                    const enhancedDuplicateDetection = document.getElementById('subEnhancedDuplicateDetection').checked;
                    const treatNonEpisodesAsExtras = document.getElementById('subTreatNonEpisodesAsExtras').checked;
                    const saveTrailers = document.getElementById('subSaveTrailers').checked;
                    const saveInterviews = document.getElementById('subSaveInterviews').checked;
                    const saveGenericExtras = document.getElementById('subSaveGenericExtras').checked;
                    const saveExtrasAsStrm = document.getElementById('subSaveExtrasAsStrm').checked;
                    const useStreamingUrlFiles = document.getElementById('subUseStreamingUrlFiles').checked;
                    const downloadFullVideoForSecondaryAudio = document.getElementById('subDownloadFullVideoForSecondaryAudio').checked;

                    const queries = [];
                    document.querySelectorAll('#queriesContainer .query-row').forEach(function (row) {
                        const queryText = row.querySelector('.subQueryText').value;
                        if (queryText) {
                            const fields = [];
                            row.querySelectorAll('.subQueryField:checked').forEach(function (fieldCheckbox) {
                                fields.push(fieldCheckbox.value);
                            });
                            queries.push({ query: queryText, fields: fields });
                        }
                    });

                    return {
                        Id: id,
                        Name: name,
                        Queries: queries,
                        MinDurationMinutes: minDuration ? parseInt(minDuration, 10) : null,
                        MaxDurationMinutes: maxDuration ? parseInt(maxDuration, 10) : null,
                        DownloadPath: path,
                        EnforceSeriesParsing: enforce,
                        AllowAudioDescription: allowAudio,
                        AllowAbsoluteEpisodeNumbering: allowAbsolute,
                        AllowSignLanguage: allowSignLanguage,
                        EnhancedDuplicateDetection: enhancedDuplicateDetection,
                        TreatNonEpisodesAsExtras: treatNonEpisodesAsExtras,
                        SaveTrailers: saveTrailers,
                        SaveInterviews: saveInterviews,
                        SaveGenericExtras: saveGenericExtras,
                        SaveExtrasAsStrm: saveExtrasAsStrm,
                        UseStreamingUrlFiles: useStreamingUrlFiles,
                        DownloadFullVideoForSecondaryAudio: downloadFullVideoForSecondaryAudio,
                    };
                }

                show(sub, titleText) {
                    const editor = document.getElementById('subscriptionEditor');
                    const title = document.getElementById('subEditorTitle');

                    if (titleText) {
                        title.innerText = titleText;
                    } else {
                        title.innerText = sub ? "Abonnement bearbeiten" : "Neues Abonnement erstellen";
                    }

                    this.setEditorValues(sub);
                    this.config.applySubscriptionDependencies();

                    editor.style.display = 'block';
                    editor.scrollIntoView({ behavior: 'smooth' });
                }

                close() {
                    document.getElementById('subscriptionEditor').style.display = 'none';
                }
            }

            class MediathekPluginConfig {
                constructor() {
                    this.pluginId = "a31b415a-5264-419d-b152-8c8192a54994";
                    this.pluginName = "MediathekViewDL";
                    this.currentConfig = null;
                    this.currentSearchResults = [];
                    this.currentItemForAdvancedDl = null;
                    this.subscriptionEditor = new SubscriptionEditor(this);

                    // --- Dependency Rules --- Disable/hide certain fields based on other field values of subscriptions
                    this.subscriptionDependencyRules = [

                        {
                            controllerId: 'subTreatNonEpisodesAsExtras',
                            dependentId: 'subSaveTrailersContainer',
                            showWhen: true,
                            disableWhenHidden: true
                        },
                        {
                            controllerId: 'subTreatNonEpisodesAsExtras',
                            dependentId: 'subSaveInterviewsContainer',
                            showWhen: true,
                            disableWhenHidden: true
                        },
                        {
                            controllerId: 'subTreatNonEpisodesAsExtras',
                            dependentId: 'subSaveGenericExtrasContainer',
                            showWhen: true,
                            disableWhenHidden: true
                        },
                        {
                            controllerId: 'subTreatNonEpisodesAsExtras',
                            dependentId: 'subSaveExtrasAsStrmContainer',
                            showWhen: true,
                            disableWhenHidden: true
                        },
                        {
                            controllerId: 'subEnforceSeries',
                            dependentId: 'subAllowAbsoluteEpisodeNumberingContainer',
                            showWhen: true,
                            disableWhenHidden: true
                        },
                        {
                            controllerId: 'subUseStreamingUrlFiles',
                            dependentId: 'subDownloadFullVideoForSecondaryAudioContainer',
                            showWhen: false,
                            disableWhenHidden: true
                        }
                    ];
                }

                // --- Helper Functions ---
                createIconButton(icon, title, onClick, id) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.classList.add('paper-icon-button-light');
                    btn.setAttribute('is', 'emby-button');
                    btn.title = title;
                    if (id) btn.id = id;

                    if (typeof onClick === 'function') {
                        btn.onclick = onClick;
                    } else if (onClick) {
                        btn.setAttribute('onclick', onClick);
                    }

                    const iconSpan = document.createElement('span');
                    iconSpan.classList.add('material-icons', icon);
                    iconSpan.setAttribute('aria-hidden', 'true');

                    btn.appendChild(iconSpan);
                    return btn;
                }

                createCheckbox(label, checked, options = {}) {
                    const { id, value, description, className, onChange } = options;

                    const labelEl = document.createElement('label');
                    labelEl.classList.add('emby-checkbox-label');

                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.setAttribute('is', 'emby-checkbox');

                    if (id) input.id = id;
                    if (value) input.value = value;
                    if (checked) input.checked = true;
                    if (className) input.classList.add(className);
                    if (onChange) input.addEventListener('change', onChange);

                    const span = document.createElement('span');
                    span.textContent = label;

                    labelEl.appendChild(input);
                    labelEl.appendChild(span);

                    if (description) {
                        const container = document.createElement('div');
                        container.classList.add('checkboxContainer', 'checkboxContainer-withDescription');
                        container.appendChild(labelEl);

                        const descEl = document.createElement('div');
                        descEl.classList.add('fieldDescription');
                        descEl.textContent = description;
                        container.appendChild(descEl);

                        return container;
                    }

                    return labelEl;
                }

                confirmationPopup(message, title, resultCallback) {
                    if (typeof Dashboard !== 'undefined' && typeof Dashboard.confirm === 'function') {
                        Dashboard.confirm(message, title, resultCallback);
                    } else {
                        const result = confirm(title + "\n\n" + message);
                        resultCallback(result);
                    }
                }

                showToast(message) {
                    if (typeof Dashboard !== 'undefined' && typeof Dashboard.alert === 'function') {
                        Dashboard.alert(message);
                    } else {
                        alert(message);
                    }
                }

                openFolderDialog(inputId, headerText) {
                    try {
                        if (typeof Dashboard !== 'undefined' && Dashboard.DirectoryBrowser) {
                            const picker = new Dashboard.DirectoryBrowser();
                            picker.show({
                                header: headerText,
                                includeDirectories: true,
                                includeFiles: false,
                                callback: (path) => {
                                    if (path) {
                                        document.getElementById(inputId).value = path;
                                    }
                                    picker.close();
                                }
                            });
                        } else {
                            var currentValue = document.getElementById(inputId).value;
                            var newPath = prompt(headerText + '\nAktueller Pfad: ' + currentValue, currentValue);
                            if (newPath !== null && newPath.trim() !== '') {
                                document.getElementById(inputId).value = newPath.trim();
                            }
                        }
                    } catch (e) {
                        console.error('Error opening folder dialog:', e);
                        var currentValue = document.getElementById(inputId).value;
                        var newPath = prompt(headerText + '\nAktueller Pfad: ' + currentValue, currentValue);
                        if (newPath !== null && newPath.trim() !== '') {
                            document.getElementById(inputId).value = newPath.trim();
                        }
                    }
                }

                genUUID() {
                    try {
                        return crypto.randomUUID();
                    } catch (e) {
                        console.error('Error generating UUID using crypto.randomUUID():', e);
                    }
                    console.warn('Falling back to manual UUID generation.');
                    // Fallback method, this is not cryptographically secure but sufficient for our use case
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                        var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }

                applySubscriptionDependencies() {
                    this.subscriptionDependencyRules.forEach(rule => {
                        const controller = document.getElementById(rule.controllerId);
                        const dependentContainer = document.getElementById(rule.dependentId);

                        if (controller && dependentContainer) {
                            const shouldShow = controller.checked === rule.showWhen;
                            dependentContainer.style.display = shouldShow ? 'block' : 'none';

                            if (rule.disableWhenHidden && !shouldShow) {
                                const dependentInput = dependentContainer.querySelector('input[type="checkbox"]');
                                if (dependentInput) {
                                    dependentInput.checked = false;
                                }
                            }
                        }
                    });
                }

                // --- Core Logic ---
                loadConfig() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(this.pluginId).then((config) => {
                        this.currentConfig = config;

                        document.querySelector('#txtDefaultDownloadPath').value = config.DefaultDownloadPath || "";
                        document.querySelector('#chkDownloadSubtitles').checked = config.DownloadSubtitles;
                        document.querySelector('#chkAllowUnknownDomains').checked = config.AllowUnknownDomains;
                        document.querySelector('#chkScanLibraryAfterDownload').checked = config.ScanLibraryAfterDownload;
                        document.querySelector('#txtMinFreeDiskSpaceMiB').value = config.MinFreeDiskSpaceBytes ? (config.MinFreeDiskSpaceBytes / (1024 * 1024)) : "";
                        document.querySelector('#lblLastRun').innerText = config.LastRun ? new Date(config.LastRun).toLocaleString() : "Noch nie";

                        this.renderSubscriptionsList();

                        Dashboard.hideLoadingMsg();
                    });
                }

                saveGlobalConfig() {
                    Dashboard.showLoadingMsg();
                    ApiClient.updatePluginConfiguration(this.pluginId, this.currentConfig).then((result) => {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                        this.showToast("Einstellungen gespeichert.");
                        this.loadConfig();
                    });
                }

                switchTab(tabId) {
                    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
                    document.getElementById('tab-' + tabId).style.display = 'block';

                    const buttons = document.querySelectorAll('.sectionTabs button');
                    buttons.forEach(btn => btn.classList.remove('selected'));

                    if (tabId === 'search') buttons[0].classList.add('selected');
                    if (tabId === 'settings') buttons[1].classList.add('selected');
                    if (tabId === 'subscriptions') buttons[2].classList.add('selected');
                }

                // --- SEARCH LOGIC ---
                performSearch() {
                    const query = document.getElementById('txtSearchQuery').value;
                    const minD = document.getElementById('numMinDuration').value;
                    const maxD = document.getElementById('numMaxDuration').value;

                    if (!query) {
                        this.showToast("Bitte Suchbegriff eingeben");
                        return;
                    }

                    Dashboard.showLoadingMsg();
                    let url = ApiClient.getUrl('/' + this.pluginName + '/Search');
                    url += '?query=' + encodeURIComponent(query);
                    if (minD) url += '&minDuration=' + minD;
                    if (maxD) url += '&maxDuration=' + maxD;

                    ApiClient.getJSON(url).then((results) => {
                        this.currentSearchResults = results; // Store results
                        this.renderSearchResults();
                        Dashboard.hideLoadingMsg();
                    }).catch((err) => {
                        Dashboard.hideLoadingMsg();
                        this.showToast("Fehler bei der Suche: " + err);
                    });
                }

                renderSearchResults() {
                    const container = document.getElementById('searchResults');
                    container.textContent = "";

                    if (!this.currentSearchResults || this.currentSearchResults.length === 0) {
                        const noRes = document.createElement('p');
                        noRes.textContent = "Keine Ergebnisse gefunden.";
                        container.appendChild(noRes);
                        return;
                    }

                    const paperList = document.createElement('div');
                    paperList.classList.add('paperList');

                    this.currentSearchResults.forEach((item, index) => {
                        paperList.appendChild(this.createSearchResultItem(item, index));
                    });
                    container.appendChild(paperList);
                }

                createSearchResultItem(item, index) {
                    const durationStr = Math.floor(item.duration / 60) + " Min";

                    const listItem = document.createElement('div');
                    listItem.classList.add('listItem', 'listItem-border');

                    const body = document.createElement('div');
                    body.classList.add('listItemBody', 'two-line');

                    const title = document.createElement('h3');
                    title.classList.add('listItemBodyText');
                    title.textContent = item.title;

                    const details = document.createElement('div');
                    details.classList.add('listItemBodyText', 'secondary');
                    details.style.display = 'inline-flex';
                    details.style.alignItems = 'center';
                    details.style.gap = '8px';

                    const detailsText = document.createElement('span');
                    detailsText.textContent = item.channel + ' | ' + item.topic + ' | ' + durationStr;
                    details.appendChild(detailsText);

                    if (item.url_subtitle) {
                        const sep = document.createElement('span');
                        sep.textContent = ' | ';
                        details.appendChild(sep);

                        const icon = document.createElement('span');
                        icon.classList.add('material-icons', 'closed_caption');
                        icon.title = 'Untertitel verfügbar';
                        details.appendChild(icon);
                    }

                    const desc = document.createElement('div');
                    desc.classList.add('listItemBodyText', 'secondary');
                    desc.style.fontSize = '0.9em';
                    desc.style.opacity = '0.7';
                    desc.textContent = item.description || '';

                    body.appendChild(title);
                    body.appendChild(details);
                    body.appendChild(desc);

                    const actions = document.createElement('div');
                    actions.style.display = 'flex';
                    actions.style.gap = '10px';

                    actions.appendChild(this.createIconButton('file_download', 'Herunterladen', () => this.downloadItem(index)));
                    actions.appendChild(this.createIconButton('settings', 'Erweiterter Download', () => this.openAdvancedDownloadDialog(index)));
                    actions.appendChild(this.createIconButton('add', 'Abo erstellen', () => this.createSubFromSearch(null, item.title, item.channel, item.topic)));

                    listItem.appendChild(body);
                    listItem.appendChild(actions);

                    return listItem;
                }

                downloadItem(index) {
                    const item = this.currentSearchResults[index];
                    if (!item) return;

                    const url = ApiClient.getUrl('/' + this.pluginName + '/Download');

                    Dashboard.showLoadingMsg();
                    ApiClient.ajax({
                        type: "POST",
                        url: url,
                        data: JSON.stringify(item),
                        contentType: 'application/json'
                    }).then((result) => {
                        Dashboard.hideLoadingMsg();
                        this.showToast("Download für '" + item.title + "' gestartet.");
                    }).catch((err) => {
                        Dashboard.hideLoadingMsg();
                        this.showToast("Fehler beim Starten des Downloads: " + (err.responseJSON ? err.responseJSON.detail : "Unbekannter Fehler"));
                    });
                }

                createSubFromSearch(btn, title, channel, topic) {
                    this.switchTab('subscriptions');
                    const newSub = {
                        Id: null,
                        Name: topic,
                        Queries: [
                            { fields: ["title"], query: title },
                            { fields: ["channel"], query: channel },
                            { fields: ["topic"], query: topic }
                        ],
                        MinDurationMinutes: null,
                        MaxDurationMinutes: null,
                        DownloadPath: "",
                        EnforceSeriesParsing: false,
                        AllowAudioDescription: false
                    };
                    subscriptionEditor.show(newSub);
                }


                // --- SUBSCRIPTION LOGIC ---
                renderSubscriptionsList() {
                    const list = document.getElementById('subscriptionList');
                    list.textContent = "";

                    if (!this.currentConfig.Subscriptions || this.currentConfig.Subscriptions.length === 0) {
                        const noSubs = document.createElement('p');
                        noSubs.textContent = "Keine aktiven Abonnements.";
                        list.appendChild(noSubs);
                        return;
                    }

                    this.currentConfig.Subscriptions.forEach((sub) => {
                        // Handle IsEnabled default true if undefined
                        if (sub.IsEnabled === undefined) sub.IsEnabled = true;

                        const queriesSummary = (sub.Queries || []).map(function (q) { return q.query; }).join(', ');
                        const lastDownloadText = sub.LastDownloadedTimestamp ? new Date(sub.LastDownloadedTimestamp).toLocaleString() : "Nie";

                        const listItem = document.createElement('div');
                        listItem.classList.add('listItem', 'listItem-border');

                        // Visual cue for disabled state
                        if (!sub.IsEnabled) {
                            listItem.style.opacity = '0.6';
                        }

                        const body = document.createElement('div');
                        body.classList.add('listItemBody', 'two-line');

                        const title = document.createElement('h3');
                        title.classList.add('listItemBodyText');
                        
                        // Add Status to title
                        const statusText = sub.IsEnabled ? "" : " (Deaktiviert)";
                        title.textContent = sub.Name + statusText;

                        const queries = document.createElement('div');
                        queries.classList.add('listItemBodyText', 'secondary');
                        queries.textContent = 'Queries: ' + queriesSummary;

                        const lastDl = document.createElement('div');
                        lastDl.classList.add('listItemBodyText', 'secondary');
                        lastDl.textContent = 'Letzter Download: ' + lastDownloadText;

                        body.appendChild(title);
                        body.appendChild(queries);
                        body.appendChild(lastDl);

                        const actions = document.createElement('div');
                        actions.style.display = 'flex';
                        actions.style.gap = '5px';

                        // Toggle Button
                        const toggleIcon = sub.IsEnabled ? 'pause_circle_outline' : 'play_circle_outline';
                        const toggleTitle = sub.IsEnabled ? 'Deaktivieren' : 'Aktivieren';
                        actions.appendChild(this.createIconButton(toggleIcon, toggleTitle, () => this.toggleSubscription(sub.Id)));

                        actions.appendChild(this.createIconButton('refresh', 'Verarbeitete Items zurücksetzen', () => this.resetProcessedItems(sub.Id)));
                        actions.appendChild(this.createIconButton('edit', 'Bearbeiten', () => subscriptionEditor.show(sub)));
                        actions.appendChild(this.createIconButton('delete', 'Löschen', () => this.deleteSubscription(sub.Id)));

                        listItem.appendChild(body);
                        listItem.appendChild(actions);
                        list.appendChild(listItem);
                    });
                }

                toggleSubscription(id) {
                    const idx = this.currentConfig.Subscriptions.findIndex(function (s) { return s.Id === id; });
                    if (idx > -1) {
                        // Toggle
                        if (this.currentConfig.Subscriptions[idx].IsEnabled === undefined) {
                            this.currentConfig.Subscriptions[idx].IsEnabled = false; // Was true (implicit), now false
                        } else {
                            this.currentConfig.Subscriptions[idx].IsEnabled = !this.currentConfig.Subscriptions[idx].IsEnabled;
                        }

                        this.saveGlobalConfig();
                    }
                }

                resetProcessedItems(id) {
                    this.confirmationPopup("Dies wird die Liste der bereits verarbeiteten Items für dieses Abonnement zurücksetzen. Es kann dazu führen, dass bereits heruntergeladene Inhalte erneut heruntergeladen werden, wenn sie noch in den Suchergebnissen der MediathekView API erscheinen. Fortfahren?", "Verarbeitete Items zurücksetzen", (confirmed) => {
                        if (confirmed) {
                            Dashboard.showLoadingMsg();
                            ApiClient.ajax({
                                type: "POST",
                                url: ApiClient.getUrl('/' + this.pluginName + '/ResetProcessedItems?subscriptionId=' + id),
                            }).then((result) => {
                                Dashboard.hideLoadingMsg();
                                this.showToast("Verarbeitete Items für Abonnement zurückgesetzt.");
                                this.loadConfig(); // Refresh the configuration to update the UI
                            }).catch((err) => {
                                Dashboard.hideLoadingMsg();
                                this.showToast("Fehler beim Zurücksetzen der verarbeiteten Items: " + (err.responseJSON ? err.responseJSON.detail : "Unbekannter Fehler"));
                            });
                        }
                    });
                }

                addQueryRow(query) {
                    if (query == null) {
                        query = { query: '', fields: ['title', 'topic'] };
                    }
                    const container = document.getElementById('queriesContainer');
                    const newRow = document.createElement('div');
                    newRow.className = 'query-row';
                    newRow.style.cssText = 'display: flex; gap: 10px; align-items: center; border: 1px solid #333; padding: 10px; border-radius: 5px;';

                    const queryText = query ? query.query : '';
                    const fields = query ? query.fields : ['title', 'topic'];

                    // Input Container
                    const inputDiv = document.createElement('div');
                    inputDiv.style.flexGrow = '1';

                    const input = document.createElement('input');
                    input.setAttribute('is', 'emby-input');
                    input.type = 'text';
                    input.className = 'subQueryText';
                    input.value = queryText;
                    input.placeholder = 'Suchtext';
                    input.required = true;

                    inputDiv.appendChild(input);
                    newRow.appendChild(inputDiv);

                    // Checkboxes
                    const checkboxesDiv = document.createElement('div');
                    checkboxesDiv.style.display = 'flex';
                    checkboxesDiv.style.gap = '15px';

                    const cbTitle = this.createCheckbox('Titel', fields.includes('title'), { value: 'title', className: 'subQueryField' });
                    const cbTopic = this.createCheckbox('Thema', fields.includes('topic'), { value: 'topic', className: 'subQueryField' });
                    const cbChannel = this.createCheckbox('Sender', fields.includes('channel'), { value: 'channel', className: 'subQueryField' });

                    checkboxesDiv.appendChild(cbTitle);
                    checkboxesDiv.appendChild(cbTopic);
                    checkboxesDiv.appendChild(cbChannel);
                    newRow.appendChild(checkboxesDiv);

                    // Remove Button
                    const removeBtn = this.createIconButton('remove_circle_outline', 'Anfrage entfernen', () => {
                        newRow.remove();
                    });
                    removeBtn.classList.add('btnRemoveQuery');
                    newRow.appendChild(removeBtn);

                    container.appendChild(newRow);
                }

                saveSubscription() {
                    const subData = this.subscriptionEditor.getEditorValues();

                    if (subData.Queries.length === 0) {
                        this.showToast("Bitte mindestens eine Suchanfrage definieren.");
                        return;
                    }

                    if (!this.currentConfig.Subscriptions) this.currentConfig.Subscriptions = [];

                    if (subData.Id) {
                        const idx = this.currentConfig.Subscriptions.findIndex(function (s) { return s.Id === subData.Id; });
                        if (idx > -1) {
                            // Keep existing ID logic if needed, but here subData already has ID from hidden input if set
                            var existingId = this.currentConfig.Subscriptions[idx].Id;
                            
                            // Preserve IsEnabled state
                            var existingIsEnabled = this.currentConfig.Subscriptions[idx].IsEnabled;
                            if (existingIsEnabled === undefined) existingIsEnabled = true;

                            this.currentConfig.Subscriptions[idx] = subData;
                            this.currentConfig.Subscriptions[idx].Id = existingId; // Ensure ID consistency
                            this.currentConfig.Subscriptions[idx].IsEnabled = existingIsEnabled;
                        }
                    } else {
                        subData.Id = this.genUUID();
                        subData.IsEnabled = true; // Default enabled for new subs
                        this.currentConfig.Subscriptions.push(subData);
                    }

                    this.saveGlobalConfig();
                    subscriptionEditor.close();
                    this.renderSubscriptionsList();
                }

                deleteSubscription(id) {
                    this.confirmationPopup("Soll dieses Abonnement wirklich gelöscht werden?", "Löschen bestätigen", (confirmed) => {
                        if (confirmed) {
                            this.currentConfig.Subscriptions = this.currentConfig.Subscriptions.filter(function (s) { return s.Id !== id; });
                            this.saveGlobalConfig();
                            this.renderSubscriptionsList();
                        }
                    });
                }

                openAdvancedDownloadDialog(index) {
                    this.currentItemForAdvancedDl = this.currentSearchResults[index];
                    if (!this.currentItemForAdvancedDl) return;

                    document.getElementById('advancedDownloadTitle').innerText = 'Erweiterter Download: ' + this.currentItemForAdvancedDl.title;
                    document.getElementById('advancedDownloadIndex').value = index;

                    document.getElementById('advDlPath').value = this.currentConfig.DefaultDownloadPath || '';

                    let proposedFilename = (this.currentItemForAdvancedDl.topic || 'video') + " - " + (this.currentItemForAdvancedDl.title || 'video');
                    proposedFilename = proposedFilename.replace(/["\/\\?%*:|"<>]/g, '-') + '.mp4';
                    document.getElementById('advDlFilename').value = proposedFilename;


                    document.getElementById('advDlSubtitles').checked = this.currentConfig.DownloadSubtitles && this.currentItemForAdvancedDl.url_subtitle;
                    document.getElementById('advDlSubtitles').disabled = !this.currentItemForAdvancedDl.url_subtitle;


                    document.getElementById('advancedDownloadModal').style.display = 'flex';
                }

                closeAdvancedDownloadDialog() {
                    document.getElementById('advancedDownloadModal').style.display = 'none';
                }

                performAdvancedDownload() {
                    if (!this.currentItemForAdvancedDl) return;

                    const downloadOptions = {
                        item: this.currentItemForAdvancedDl,
                        downloadPath: document.getElementById('advDlPath').value,
                        fileName: document.getElementById('advDlFilename').value,
                        downloadSubtitles: document.getElementById('advDlSubtitles').checked
                    };

                    const url = ApiClient.getUrl('/' + this.pluginName + '/AdvancedDownload');

                    Dashboard.showLoadingMsg();
                    ApiClient.ajax({
                        type: "POST",
                        url: url,
                        data: JSON.stringify(downloadOptions),
                        contentType: 'application/json'
                    }).then((result) => {
                        Dashboard.hideLoadingMsg();
                        this.closeAdvancedDownloadDialog();
                        this.showToast("Download für '" + this.currentItemForAdvancedDl.title + "' gestartet.");
                    }).catch((err) => {
                        Dashboard.hideLoadingMsg();
                        this.showToast("Fehler beim Starten des Downloads: " + (err.responseJSON ? err.responseJSON.detail : "Unbekannter Fehler"));
                    });
                }

                init() {
                    document.querySelector('#MediathekViewDLConfigPage').addEventListener('pageshow', () => {
                        this.loadConfig();
                    });

                    document.querySelector('#MediathekGeneralConfigForm').addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.currentConfig.DefaultDownloadPath = document.querySelector('#txtDefaultDownloadPath').value;
                        this.currentConfig.DownloadSubtitles = document.querySelector('#chkDownloadSubtitles').checked;
                        this.currentConfig.AllowUnknownDomains = document.querySelector('#chkAllowUnknownDomains').checked;
                        this.currentConfig.ScanLibraryAfterDownload = document.querySelector('#chkScanLibraryAfterDownload').checked;
                        const minFreeSpaceMiB = parseInt(document.querySelector('#txtMinFreeDiskSpaceMiB').value, 10);
                        this.currentConfig.MinFreeDiskSpaceBytes = isNaN(minFreeSpaceMiB) ? (1.5 * 1024 * 1024 * 1024) : (minFreeSpaceMiB * 1024 * 1024);
                        this.saveGlobalConfig();
                        return false;
                    });

                    document.getElementById('btnSelectPath').addEventListener('click', () => {
                        this.openFolderDialog('txtDefaultDownloadPath', 'Standard Download Pfad wählen');
                    });

                    document.getElementById('btnSelectSubPath').addEventListener('click', () => {
                        this.openFolderDialog('subPath', 'Abo Pfad wählen');
                    });

                    document.getElementById('btnSelectAdvPath').addEventListener('click', () => {
                        this.openFolderDialog('advDlPath', 'Download Pfad wählen');
                    });

                    const controllerIds = [...new Set(this.subscriptionDependencyRules.map(rule => rule.controllerId))];
                    controllerIds.forEach(id => {
                        const controller = document.getElementById(id);
                        if (controller) {
                            controller.addEventListener('change', () => this.applySubscriptionDependencies());
                        }
                    });
                }
            }

            const mediathekConfig = new MediathekPluginConfig();
            const subscriptionEditor = mediathekConfig.subscriptionEditor;
            mediathekConfig.init();
        </script>
        <style>
            .tabs-spacer {
                margin-bottom: 20px;
                border-bottom: 1px solid #333;
            }

            .sectionTabs button.selected {
                color: #00a4dc;
                border-bottom: 2px solid #00a4dc;
            }

            .listItemBodyText.secondary {
                color: #aaa;
            }
        </style>
    </div>
</body>
</html>
