<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <title>Mediathek Downloader</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="/web/themes/base.css" />
    <link rel="stylesheet" type="text/css" href="/web/themes/shared.css" />
    <style>
        /* Deine Styles (leicht angepasst) */
        .page { margin: 2em; }
        .config-tabs { border-bottom: 1px solid #444; margin-bottom: 2em; }
        .tab-button { background: none; border: none; color: #ccc; padding: 1em 1.5em; cursor: pointer; font-size: 1em; }
        .tab-button.active { color: #00a4dc; border-bottom: 2px solid #00a4dc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section { margin-bottom: 2em; }
        .input-group { display:flex; align-items:center; margin-bottom:1em; gap:0.5rem; }
        .result-item, .sub-item { background-color:#1a1a1a; padding:1em; border-radius:5px; margin-bottom:1em; border-left:3px solid #00a4dc; }
        .result-details { font-size:0.9em; color:#aaa; margin-bottom:1em; }
        .sub-form { display:grid; grid-template-columns:150px 1fr; gap:1em; }
        .spinner { border:4px solid rgba(255,255,255,0.2); border-left-color:#00a4dc; border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; display:none; margin:1em auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- Wichtig: Wrapper wie im Template -->
    <div id="MediathekDownloaderConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
         data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <!-- UI (Struktur ähnlich wie vorher) -->
                <div class="page">
                    <h1 class="page-title">Mediathek Downloader</h1>

                    <div class="config-tabs">
                        <button is="emby-button" class="tab-button active" data-tab="tab-settings"><span>Einstellungen &amp; Suche</span></button>
                        <button is="emby-button" class="tab-button" data-tab="tab-subs"><span>Abonnements</span></button>
                    </div>

                    <form id="MediathekDownloaderConfigForm">
                        <div id="tab-settings" class="tab-content active">
                            <div class="section">
                                <h3>Allgemeine Einstellungen</h3>
                                <div class="paper-form">
                                    <div class="input-container">
                                        <input is="emby-input" type="text" id="txtDefaultDownloadPath" name="DefaultDownloadPath" class="text-input" />
                                        <div class="input-label">Standard-Downloadpfad</div>
                                    </div>
                                </div>
                            </div>

                            <div class="section">
                                <h3>Manuelle Suche</h3>
                                <div class="input-group paper-form">
                                    <input is="emby-input" type="text" id="txtSearchQuery" class="text-input" placeholder="z.B. 'Tatort Münster'" />
                                    <button is="emby-button" type="button" id="btnSearch"><span>Suchen</span></button>
                                </div>
                                <div class="input-group paper-form">
                                    <input is="emby-input" type="number" id="txtMinDuration" class="text-input" placeholder="Min. Dauer (Sekunden, optional)" />
                                    <input is="emby-input" type="number" id="txtMaxDuration" class="text-input" placeholder="Max. Dauer (Sekunden, optional)" />
                                </div>
                                <div class="spinner" id="searchSpinner"></div>
                                <div id="searchResults"></div>
                            </div>
                        </div>

                        <div id="tab-subs" class="tab-content">
                            <div class="section">
                                <button is="emby-button" type="button" id="btnAddSub"><span>Neues Abo hinzufügen</span></button>
                            </div>
                            <div id="subscriptionsContainer"></div>
                        </div>

                        <!-- Unsichtbarer submit-Button (wie Template pattern) -->
                        <button is="emby-button" type="submit" id="btnSave" style="display:none;"><span>Save</span></button>
                    </form>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            (function () {
                // --- Konfiguration ---
                var PluginConfig = {
                    pluginUniqueId: 'a31b415a-5264-419d-b152-8c8192a54994'
                };

                // Verwende globalen ApiClient wie im Template (nicht window.ApiClient wrapper)
                function getApi() { return window.ApiClient; }

                // Hilfsfunktionen
                function genUUID() {
                    if (crypto?.randomUUID) { try { return crypto.randomUUID(); } catch (e) {} }
                    if (crypto?.getRandomValues) {
                        const bytes = crypto.getRandomValues(new Uint8Array(16));
                        bytes[6] = (bytes[6] & 0x0f) | 0x40;
                        bytes[8] = (bytes[8] & 0x3f) | 0x80;
                        const hex = [...bytes].map(b => b.toString(16).padStart(2,'0')).join('');
                        return hex.slice(0,8)+'-'+hex.slice(8,12)+'-'+hex.slice(12,16)+'-'+hex.slice(16,20)+'-'+hex.slice(20);
                    }
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                        const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }

                // --- App API Client (nutzt ApiClient wie im Template) ---
                var AppApiClient = {
                    getConfig: function () {
                        return getApi().getPluginConfiguration(PluginConfig.pluginUniqueId);
                    },
                    updateConfig: function (cfg) {
                        return getApi().updatePluginConfiguration(PluginConfig.pluginUniqueId, cfg);
                    },
                    // Implementierte Suche: ruft Plugin-Controller-Endpunkt 'MediathekViewDL/Search' auf
                    search: function (query, minDuration, maxDuration) {
                        var base = getApi().getUrl ? getApi().getUrl('MediathekViewDL/Search') : '/MediathekViewDL/Search';
                        var params = [];
                        params.push('query=' + encodeURIComponent(query));
                        if (minDuration != null) params.push('minDuration=' + encodeURIComponent(minDuration));
                        if (maxDuration != null) params.push('maxDuration=' + encodeURIComponent(maxDuration));
                        var url = base + (params.length ? ('?' + params.join('&')) : '');
                        return getApi().getJSON(url);
                    },
                    download: function (item) {
                        var url = getApi().getUrl ? getApi().getUrl('MediathekViewDL/Download') : '/MediathekViewDL/Download';
                        return getApi().ajax({
                            type: 'POST',
                            url: url,
                            dataType: 'json',
                            contentType: 'application/json',
                            data: JSON.stringify(item)
                        });
                    }
                };

                // --- UI / State ---
                var config = {};
                var txtDefaultDownloadPath = document.getElementById('txtDefaultDownloadPath');
                var subscriptionsContainer = document.getElementById('subscriptionsContainer');
                var searchSpinner = document.getElementById('searchSpinner');
                var searchResultsContainer = document.getElementById('searchResults');

                // Tabs (wie vorher)
                document.querySelectorAll('.tab-button').forEach(function (button) {
                    button.addEventListener('click', function () {
                        document.querySelectorAll('.tab-button, .tab-content').forEach(function (el) { el.classList.remove('active'); });
                        button.classList.add('active');
                        document.getElementById(button.dataset.tab).classList.add('active');
                    });
                });

                // --- Load / Save (verwende pageshow wie Template) ---
                document.querySelector('#MediathekDownloaderConfigPage').addEventListener('pageshow', function () {
                    Dashboard.showLoadingMsg();
                    AppApiClient.getConfig().then(function (cfg) {
                        config = cfg || {};
                        if (!config.Subscriptions) config.Subscriptions = [];
                        txtDefaultDownloadPath.value = config.DefaultDownloadPath || '';
                        renderSubscriptions();
                        Dashboard.hideLoadingMsg();
                    }).catch(function (e) {
                        console.error('Error loading config', e);
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Fehler beim Laden der Konfiguration.');
                    });
                });

                document.querySelector('#MediathekDownloaderConfigForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    Dashboard.showLoadingMsg();
                    // Build config from DOM
                    config.DefaultDownloadPath = txtDefaultDownloadPath.value;
                    var subForms = subscriptionsContainer.querySelectorAll('.sub-item');
                    var updatedSubs = [];
                    subForms.forEach(function (form) {
                        updatedSubs.push({
                            Id: form.dataset.id,
                            Name: form.querySelector('[name="SubName"]').value,
                            SearchQuery: form.querySelector('[name="SubSearchQuery"]').value,
                            DownloadPath: form.querySelector('[name="SubDownloadPath"]').value,
                            EnforceSeriesParsing: form.querySelector('[name="SubEnforceSeriesParsing"]').checked,
                            AllowAudioDescription: form.querySelector('[name="SubAllowAudioDescription"]').checked
                        });
                    });
                    config.Subscriptions = updatedSubs;

                    AppApiClient.updateConfig(config).then(function (result) {
                        // Nutze Dashboard helper wie im Template (prozessiert Meldungen korrekt)
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    }).catch(function (err) {
                        console.error('Error saving config', err);
                        Dashboard.alert('Fehler beim Speichern der Konfiguration.');
                    }).finally(function () {
                        Dashboard.hideLoadingMsg();
                    });
                });

                // --- Subscriptions rendering / management (beibehalten) ---
                function renderSubscriptions() {
                    subscriptionsContainer.innerHTML = '';
                    (config.Subscriptions || []).forEach(function (sub) {
                        var subId = sub.Id || ('new_' + Date.now());
                        var subDiv = document.createElement('div');
                        subDiv.className = 'sub-item';
                        subDiv.dataset.id = subId;

                        var h4 = document.createElement('h4');
                        h4.textContent = 'Abo: ' + (sub.Name || 'Neues Abo');
                        subDiv.appendChild(h4);

                        var paperForm = document.createElement('div');
                        paperForm.className = 'paper-form';
                        var subForm = document.createElement('div');
                        subForm.className = 'sub-form';

                        // Name
                        var labelName = document.createElement('label');
                        labelName.setAttribute('for', 'subName_' + subId);
                        labelName.textContent = 'Name:';
                        subForm.appendChild(labelName);
                        var inputName = document.createElement('input');
                        inputName.type = 'text';
                        inputName.name = 'SubName';
                        inputName.id = 'subName_' + subId;
                        inputName.className = 'text-input';
                        inputName.value = sub.Name || '';
                        inputName.placeholder = 'Name des Abos (wird zum Ordnernamen)';
                        subForm.appendChild(inputName);

                        // Query
                        var labelQuery = document.createElement('label');
                        labelQuery.setAttribute('for', 'subQuery_' + subId);
                        labelQuery.textContent = 'Suchbegriff:';
                        subForm.appendChild(labelQuery);
                        var inputQuery = document.createElement('input');
                        inputQuery.type = 'text';
                        inputQuery.name = 'SubSearchQuery';
                        inputQuery.id = 'subQuery_' + subId;
                        inputQuery.className = 'text-input';
                        inputQuery.value = sub.SearchQuery || '';
                        inputQuery.placeholder = 'Suchbegriff für die API';
                        subForm.appendChild(inputQuery);

                        // Path
                        var labelPath = document.createElement('label');
                        labelPath.setAttribute('for', 'subPath_' + subId);
                        labelPath.textContent = 'Downloadpfad:';
                        subForm.appendChild(labelPath);
                        var inputPath = document.createElement('input');
                        inputPath.type = 'text';
                        inputPath.name = 'SubDownloadPath';
                        inputPath.id = 'subPath_' + subId;
                        inputPath.className = 'text-input';
                        inputPath.value = sub.DownloadPath || '';
                        inputPath.placeholder = 'Optional, überschreibt Standardpfad';
                        subForm.appendChild(inputPath);

                        // Series checkbox
                        subForm.appendChild(document.createElement('div'));
                        var checkboxContainerSeries = document.createElement('div');
                        checkboxContainerSeries.className = 'checkbox-container';
                        var labelSeries = document.createElement('label');
                        labelSeries.className = 'checkbox-label';
                        var inputSeries = document.createElement('input');
                        inputSeries.type = 'checkbox';
                        inputSeries.name = 'SubEnforceSeriesParsing';
                        inputSeries.className = 'emby-checkbox';
                        inputSeries.checked = !!sub.EnforceSeriesParsing;
                        var spanSeries = document.createElement('span');
                        spanSeries.textContent = 'Nur bei erkannter Staffel/Episode laden';
                        labelSeries.appendChild(inputSeries);
                        labelSeries.appendChild(spanSeries);
                        checkboxContainerSeries.appendChild(labelSeries);
                        subForm.appendChild(checkboxContainerSeries);

                        // Audio checkbox
                        subForm.appendChild(document.createElement('div'));
                        var checkboxContainerAudio = document.createElement('div');
                        checkboxContainerAudio.className = 'checkbox-container';
                        var labelAudio = document.createElement('label');
                        labelAudio.className = 'checkbox-label';
                        var inputAudio = document.createElement('input');
                        inputAudio.type = 'checkbox';
                        inputAudio.name = 'SubAllowAudioDescription';
                        inputAudio.className = 'emby-checkbox';
                        inputAudio.checked = !!sub.AllowAudioDescription;
                        var spanAudio = document.createElement('span');
                        spanAudio.textContent = 'Audiodeskription-Versionen erlauben';
                        labelAudio.appendChild(inputAudio);
                        labelAudio.appendChild(spanAudio);
                        checkboxContainerAudio.appendChild(labelAudio);
                        subForm.appendChild(checkboxContainerAudio);

                        paperForm.appendChild(subForm);

                        var deleteButton = document.createElement('button');
                        deleteButton.is = 'emby-button';
                        deleteButton.type = 'button';
                        deleteButton.className = 'paper-button btn-delete-sub';
                        deleteButton.dataset.id = subId;
                        deleteButton.textContent = 'Löschen';
                        paperForm.appendChild(deleteButton);

                        subDiv.appendChild(paperForm);
                        subscriptionsContainer.appendChild(subDiv);
                    });
                }

                document.getElementById('btnAddSub').addEventListener('click', function () {
                    var newId = genUUID();
                    config.Subscriptions.push({
                        Id: newId, Name: '', SearchQuery: '', DownloadPath: '', EnforceSeriesParsing: true, AllowAudioDescription: false
                    });
                    renderSubscriptions();
                });

                subscriptionsContainer.addEventListener('click', function (e) {
                    if (e.target.classList.contains('btn-delete-sub')) {
                        var subIdToDelete = e.target.dataset.id;
                        config.Subscriptions = (config.Subscriptions || []).filter(function (s) { return s.Id !== subIdToDelete; });
                        renderSubscriptions();
                    }
                });

                // --- SEARCH / RESULTS ---
                document.getElementById('btnSearch').addEventListener('click', function () {
                    var query = document.getElementById('txtSearchQuery').value;
                    var minDuration = parseInt(document.getElementById('txtMinDuration').value);
                    var maxDuration = parseInt(document.getElementById('txtMaxDuration').value);
                    var finalMinDuration = isNaN(minDuration) ? null : minDuration;
                    var finalMaxDuration = isNaN(maxDuration) ? null : maxDuration;
                    if (!query) return;
                    searchResultsContainer.innerHTML = '';
                    searchSpinner.style.display = 'block';
                    AppApiClient.search(query, finalMinDuration, finalMaxDuration).then(function (results) {
                        renderSearchResults(results || [], query);
                    }).catch(function (err) {
                        console.error('Search failed', err);
                        Dashboard.alert('Fehler bei der Suche.');
                    }).finally(function () {
                        searchSpinner.style.display = 'none';
                    });
                });

                function renderSearchResults(results, originalQuery) {
                    searchResultsContainer.innerHTML = '';
                    if (!results || results.length === 0) {
                        searchResultsContainer.innerHTML = '<p>Keine Ergebnisse gefunden.</p>';
                        return;
                    }
                    results.forEach(function (item) {
                        var itemDiv = document.createElement('div');
                        itemDiv.className = 'result-item';

                        var itemDate = item.timestamp ? new Date(item.timestamp * 1000).toLocaleString() : '';
                        var itemDuration = item.duration ? (Math.round(item.duration / 60) + ' min') : '';

                        var h4 = document.createElement('h4');
                        h4.textContent = item.title || item.topic || '';
                        itemDiv.appendChild(h4);

                        var resultDetailsDiv = document.createElement('div');
                        resultDetailsDiv.className = 'result-details';
                        var spanChannel = document.createElement('span'); spanChannel.textContent = item.channel || '';
                        var spanDate = document.createElement('span'); spanDate.textContent = itemDate;
                        var spanDuration = document.createElement('span'); spanDuration.textContent = itemDuration;
                        resultDetailsDiv.appendChild(spanChannel);
                        resultDetailsDiv.appendChild(document.createTextNode(' | '));
                        resultDetailsDiv.appendChild(spanDate);
                        resultDetailsDiv.appendChild(document.createTextNode(' | '));
                        resultDetailsDiv.appendChild(spanDuration);
                        itemDiv.appendChild(resultDetailsDiv);

                        var pDescription = document.createElement('p');
                        pDescription.textContent = item.description || '';
                        itemDiv.appendChild(pDescription);

                        var btnDownload = document.createElement('button');
                        btnDownload.is = 'emby-button';
                        btnDownload.type = 'button';
                        btnDownload.className = 'paper-button btn-download';
                        btnDownload.dataset.item = JSON.stringify(item);
                        btnDownload.textContent = 'Einzel-Download';
                        itemDiv.appendChild(btnDownload);

                        var btnAddAsSubscription = document.createElement('button');
                        btnAddAsSubscription.is = 'emby-button';
                        btnAddAsSubscription.type = 'button';
                        btnAddAsSubscription.className = 'paper-button btn-add-from-search';
                        btnAddAsSubscription.dataset.query = originalQuery;
                        btnAddAsSubscription.dataset.title = item.topic || item.title || '';
                        btnAddAsSubscription.textContent = 'Als Abo speichern';
                        itemDiv.appendChild(btnAddAsSubscription);

                        searchResultsContainer.appendChild(itemDiv);
                    });
                }

                searchResultsContainer.addEventListener('click', function (e) {
                    if (e.target.classList.contains('btn-download')) {
                        var item = JSON.parse(e.target.dataset.item);
                        // Verwende API call und informiere via Dashboard.processPluginConfigurationUpdateResult oder einfacher Alert
                        AppApiClient.download(item).then(function () {
                            Dashboard.alert('Download angefordert.');
                        }).catch(function (err) {
                            console.error('Download failed', err);
                            Dashboard.alert('Fehler beim Starten des Downloads.');
                        });
                    }
                    if (e.target.classList.contains('btn-add-from-search')) {
                        var newId = genUUID();
                        config.Subscriptions.push({
                            Id: newId,
                            Name: e.target.dataset.title,
                            SearchQuery: e.target.dataset.query,
                            DownloadPath: '',
                            EnforceSeriesParsing: true,
                            AllowAudioDescription: false
                        });
                        renderSubscriptions();
                        Dashboard.alert('Abo hinzugefügt. Bitte speichern.');
                        // Switch to subscriptions tab
                        document.querySelectorAll('.tab-button, .tab-content').forEach(function (el) { el.classList.remove('active'); });
                        document.querySelector('[data-tab="tab-subs"]').classList.add('active');
                        document.getElementById('tab-subs').classList.add('active');
                    }
                });

                // Ende IIFE
            })();
        </script>
    </div>
</body>
</html>
