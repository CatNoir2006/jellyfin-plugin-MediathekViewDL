<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <title>MediathekView Plugin Konfiguration</title>
</head>

<body>
    <div id="MediathekViewDLConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
        data-require="emby-input,emby-button,emby-select,emby-checkbox,emby-linkbutton">

        <div data-role="content">
            <div class="content-primary">

                <!-- Tab Navigation -->
                <div class="sectionTabs tabs-spacer">
                    <button type="button" class="paper-icon-button-light selected"
                        onclick="MediathekPluginConfig.switchTab('search')">
                        <span class="material-icons search" aria-hidden="true"></span>
                        <span>Manuelle Suche</span>
                    </button>
                    <button type="button" class="paper-icon-button-light"
                        onclick="MediathekPluginConfig.switchTab('settings')">
                        <span class="material-icons settings" aria-hidden="true"></span>
                        <span>Einstellungen</span>
                    </button>
                    <button type="button" class="paper-icon-button-light"
                        onclick="MediathekPluginConfig.switchTab('subscriptions')">
                        <span class="material-icons subscriptions" aria-hidden="true"></span>
                        <span>Abo Verwaltung</span>
                    </button>
                </div>

                <!-- TAB 1: SUCHE -->
                <div id="tab-search" class="tab-content" style="display:block;">
                    <div class="verticalSection">
                        <div class="sectionTitleLabel">Mediathek durchsuchen</div>
                        <p class="sectionDescription">Suche nach Inhalten, um diese direkt herunterzuladen oder ein Abo
                            zu erstellen.</p>

                        <form onsubmit="MediathekPluginConfig.performSearch(); return false;">
                            <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                                <div class="inputContainer" style="flex-grow: 1;">
                                    <label class="inputLabel" for="txtSearchQuery">Suchbegriff</label>
                                    <input is="emby-input" type="text" id="txtSearchQuery" required />
                                </div>
                                <div class="inputContainer" style="width: 150px;">
                                    <label class="inputLabel" for="numMinDuration">Min. Dauer (Sek)</label>
                                    <input is="emby-input" type="number" id="numMinDuration" />
                                </div>
                                <div class="inputContainer" style="width: 150px;">
                                    <label class="inputLabel" for="numMaxDuration">Max. Dauer (Sek)</label>
                                    <input is="emby-input" type="number" id="numMaxDuration" />
                                </div>
                                <div class="inputContainer">
                                    <button is="emby-button" type="submit" class="raised button-submit block">
                                        <span>Suchen</span>
                                    </button>
                                </div>
                            </div>
                        </form>

                        <div id="searchResults" style="margin-top: 20px;">
                            <!-- Ergebnisse werden hier gerendert -->
                        </div>
                    </div>
                </div>

                <!-- TAB 2: EINSTELLUNGEN -->
                <div id="tab-settings" class="tab-content" style="display:none;">
                    <div class="verticalSection">
                        <div class="sectionTitleLabel">Allgemeine Einstellungen</div>
                        <form id="MediathekGeneralConfigForm">

                            <div class="inputContainer">
                                <div style="display: flex; align-items: center;">
                                    <div style="flex-grow: 1;">
                                        <label class="inputLabel" for="txtDefaultDownloadPath">Standard Download
                                            Pfad</label>
                                        <input is="emby-input" type="text" id="txtDefaultDownloadPath" />
                                        <div class="fieldDescription">Der Standard-Ordner für alle Downloads, sofern im
                                            Abo nichts anderes definiert ist.</div>
                                    </div>
                                    <button type="button" is="paper-icon-button-light" id="btnSelectPath"
                                        title="Ordner auswählen" style="margin-left: 10px; margin-top: 15px;">
                                        <span class="material-icons folder_open"></span>
                                    </button>
                                </div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription" style="margin-top: 20px;">
                                <label class="emby-checkbox-label">
                                    <input id="chkDownloadSubtitles" type="checkbox" is="emby-checkbox" />
                                    <span>Untertitel herunterladen (wenn verfügbar)</span>
                                </label>
                                <div class="fieldDescription">Lädt eine separate VTT- oder TTML-Datei für Untertitel
                                    herunter, falls vom Sender bereitgestellt.</div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription" style="margin-top: 20px;">
                                <label class="emby-checkbox-label">
                                    <input id="chkAllowUnknownDomains" type="checkbox" is="emby-checkbox" />
                                    <span>Downloads von unbekannten Domains erlauben</span>
                                </label>
                                <div class="fieldDescription">Ermöglicht das Herunterladen von Inhalten von Domains, die
                                    nicht auf der Whitelist stehen. Dies kann nützlich sein, wenn ARD oder ZDF neue CDNs
                                    hinzufügen, die noch nicht berücksichtigt werden. Dies kann jedoch ein
                                    Sicherheitsrisiko darstellen, daher mit Vorsicht verwenden. Falls dadurch manche
                                    Inhalte nicht gefunden werden wäre es schon wenn auf GitHub ein Issue erstellt wird,
                                    das ich die Whitelist ggf. erweitern kann.</div>
                            </div>

                            <div class="inputContainer">
                                <label class="inputLabel" for="txtMinFreeDiskSpaceMiB">Mindestfreier Speicherplatz
                                    (MiB)</label>
                                <input is="emby-input" type="number" id="txtMinFreeDiskSpaceMiB" />
                                <div class="fieldDescription">Legt den minimalen freien Speicherplatz fest, der
                                    erforderlich ist, um einen neuen Download zu starten.</div>
                            </div>

                            <!-- Anzeige des letzten Laufs (Read Only) -->
                            <div class="inputContainer">
                                <label class="inputLabel">Letzter Lauf</label>
                                <div id="lblLastRun" style="padding: 10px 0;">Noch nie</div>
                            </div>

                            <div>
                                <button is="emby-button" type="submit" class="raised button-submit block">
                                    <span>Speichern</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- TAB 3: ABO VERWALTUNG -->
                <div id="tab-subscriptions" class="tab-content" style="display:none;">
                    <div class="verticalSection">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="sectionTitleLabel">Aktive Abonnements</div>
                            <button is="emby-button" type="button" class="raised"
                                onclick="MediathekPluginConfig.editSubscription(null)">
                                <span class="material-icons add"></span>
                                <span>Neues Abo</span>
                            </button>
                        </div>
                        <div id="subscriptionList" class="paperList" style="margin-top: 20px;">
                            <!-- Liste wird hier gerendert -->
                        </div>
                    </div>

                    <!-- Modal/Bereich zum Editieren eines Abos (Initial versteckt) -->
                    <div id="subscriptionEditor"
                        style="display: none; border-top: 1px solid #444; margin-top: 20px; padding-top: 20px;">
                        <h3 id="subEditorTitle">Abonnement bearbeiten</h3>
                        <form onsubmit="MediathekPluginConfig.saveSubscription(); return false;">
                            <input type="hidden" id="subId" />

                            <div class="inputContainer">
                                <label class="inputLabel" for="subName">Name (Serienname)</label>
                                <input is="emby-input" type="text" id="subName" required />
                            </div>

                            <!-- Container für dynamische Queries -->
                            <div class="inputContainer">
                                <label class="inputLabel">Suchanfragen</label>
                                <div id="queriesContainer"
                                    style="display: flex; flex-direction: column; gap: 15px; margin-top: 10px;">
                                    <!-- Query-Zeilen werden hier dynamisch eingefügt -->
                                </div>
                                <button is="emby-button" type="button" class="raised"
                                    onclick="MediathekPluginConfig.addQueryRow()" style="margin-top: 10px;">
                                    <span class="material-icons add"></span>
                                    <span>Anfrage hinzufügen</span>
                                </button>
                            </div>

                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <div class="inputContainer" style="flex-grow: 1;">
                                    <label class="inputLabel" for="subMinDuration">Min. Dauer (Minuten)</label>
                                    <input is="emby-input" type="number" id="subMinDuration" />
                                </div>
                                <div class="inputContainer" style="flex-grow: 1;">
                                    <label class="inputLabel" for="subMaxDuration">Max. Dauer (Minuten)</label>
                                    <input is="emby-input" type="number" id="subMaxDuration" />
                                </div>
                            </div>

                            <div class="inputContainer">
                                <div style="display: flex; align-items: center;">
                                    <div style="flex-grow: 1;">
                                        <label class="inputLabel" for="subPath">Download Pfad (Optional)</label>
                                        <input is="emby-input" type="text" id="subPath" />
                                        <div class="fieldDescription">Leer lassen, um den Standardpfad zu nutzen.</div>
                                    </div>
                                    <button type="button" is="paper-icon-button-light" id="btnSelectSubPath"
                                        title="Ordner auswählen" style="margin-left: 10px; margin-top: 15px;">
                                        <span class="material-icons folder_open"></span>
                                    </button>
                                </div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="subEnforceSeries" type="checkbox" is="emby-checkbox" />
                                    <span>Nur Serien herunterladen</span>
                                </label>
                                <div class="fieldDescription">Nur Videos herunterladen, die als Serie erkannt werden
                                </div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="subUseStreamingUrlFiles" type="checkbox" is="emby-checkbox" />
                                    <span>Streaming-URL-Dateien (.strm) verwenden</span>
                                </label>
                                <div class="fieldDescription">Verwendet Streaming-URL-Dateien (.strm) anstelle des
                                    Herunterladens der tatsächlichen Videodateien. Es werden keine Videodateien
                                    gespeichert, die Videos werden von ARD/ZDF direkt gestreamt. Untertitel sind hiervon nicht betroffen.</div>
                            </div>

                            <div id="subTreatNonEpisodesAsExtrasContainer" class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="subTreatNonEpisodesAsExtras" type="checkbox" is="emby-checkbox" />
                                    <span>Nicht Episoden als Extras behandeln</span>
                                </label>
                                <div class="fieldDescription">Nicht als Episoden erkannte Videos als Extras behandeln.
                                    Wird ignoriert, wenn "Nur Serien herunterladen" aktiviert ist.</div>
                            </div>

                            <div id="subAllowAbsoluteEpisodeNumberingContainer" class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="subAllowAbsoluteEpisodeNumbering" type="checkbox" is="emby-checkbox" />
                                    <span>Absolute Episodennummerierung erlauben</span>
                                </label>
                                <div class="fieldDescription">Episoden auch herunterladen wenn nur Absolute
                                    Episodennummerierung vorliegt (z.B. "Episode 5" statt "Staffel 1, Episode 5"). Wird
                                    nur berücksichtigt, wenn "Nur Videos herunterladen, die als Serie erkannt werden"
                                    aktiviert ist.</div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="subAllowAudioDesc" type="checkbox" is="emby-checkbox" />
                                    <span>Versionen mit Audiodeskription erlauben</span>
                                </label>
                                <div class="fieldDescription">Erlaubt das Herunterladen von Versionen mit
                                    Audiodeskription (sofern verfügbar).</div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="subAllowSignLanguage" type="checkbox" is="emby-checkbox" />
                                    <span>Versionen mit Gebärdensprache erlauben</span>
                                </label>
                                <div class="fieldDescription">Erlaubt das Herunterladen von Versionen mit
                                    Gebärdensprache (sofern verfügbar).</div>
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <button is="emby-button" type="submit" class="raised button-submit">
                                    <span>Abo Speichern</span>
                                </button>
                                <button is="emby-button" type="button" class="raised button-cancel"
                                    onclick="MediathekPluginConfig.closeEditor()">
                                    <span>Abbrechen</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
        </div>

        <div id="advancedDownloadModal" class="dialog-host"
            style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
            <div class="dialog-content"
                style="background-color: #303030; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 5px;">
                <h2 id="advancedDownloadTitle">Erweiterter Download</h2>
                <form onsubmit="MediathekPluginConfig.performAdvancedDownload(); return false;">
                    <input type="hidden" id="advancedDownloadIndex" />

                    <div class="inputContainer">
                        <div style="display: flex; align-items: center;">
                            <div style="flex-grow: 1;">
                                <label class="inputLabel" for="advDlPath">Download Pfad</label>
                                <input is="emby-input" type="text" id="advDlPath" />
                            </div>
                            <button type="button" is="paper-icon-button-light" id="btnSelectAdvPath"
                                title="Ordner auswählen" style="margin-left: 10px; margin-top: 15px;">
                                <span class="material-icons folder_open"></span>
                            </button>
                        </div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel" for="advDlFilename">Dateiname</label>
                        <input is="emby-input" type="text" id="advDlFilename" />
                    </div>

                    <div class="checkboxContainer">
                        <label class="emby-checkbox-label">
                            <input id="advDlSubtitles" type="checkbox" is="emby-checkbox" />
                            <span>Untertitel herunterladen</span>
                        </label>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button is="emby-button" type="submit" class="raised button-submit">
                            <span>Herunterladen</span>
                        </button>
                        <button is="emby-button" type="button" class="raised button-cancel"
                            onclick="MediathekPluginConfig.closeAdvancedDownloadDialog()">
                            <span>Abbrechen</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            var MediathekPluginConfig = (function () {

                const pluginId = "a31b415a-5264-419d-b152-8c8192a54994";
                const pluginName = "MediathekViewDL";
                let currentConfig = null;
                let currentSearchResults = [];
                let currentItemForAdvancedDl = null;

                // --- Dependency Rules --- Disable/hide certain fields based on other field values of subscriptions
                const subscriptionDependencyRules = [
                    {
                        controllerId: 'subEnforceSeries',
                        dependentId: 'subTreatNonEpisodesAsExtrasContainer',
                        showWhen: false,
                        disableWhenHidden: true
                    },
                    {
                        controllerId: 'subEnforceSeries',
                        dependentId: 'subAllowAbsoluteEpisodeNumberingContainer',
                        showWhen: true,
                        disableWhenHidden: true
                    }
                ];

                // --- Helper Functions ---
                function confirmationPopup(message, title, resultCallback) {
                    if (typeof Dashboard !== 'undefined' && typeof Dashboard.confirm === 'function') {
                        Dashboard.confirm(message, title, resultCallback);
                    } else {
                        const result = confirm(title + "\n\n" + message);
                        resultCallback(result);
                    }
                }

                function showToast(message) {
                    if (typeof Dashboard !== 'undefined' && typeof Dashboard.alert === 'function') {
                        Dashboard.alert(message);
                    } else {
                        alert(message);
                    }
                }

                function openFolderDialog(inputId, headerText) {
                    try {
                        if (typeof Dashboard !== 'undefined' && Dashboard.DirectoryBrowser) {
                            const picker = new Dashboard.DirectoryBrowser();
                            picker.show({
                                header: headerText,
                                includeDirectories: true,
                                includeFiles: false,
                                callback: function (path) {
                                    if (path) {
                                        document.getElementById(inputId).value = path;
                                    }
                                    picker.close();
                                }
                            });
                        } else {
                            var currentValue = document.getElementById(inputId).value;
                            var newPath = prompt(headerText + '\nAktueller Pfad: ' + currentValue, currentValue);
                            if (newPath !== null && newPath.trim() !== '') {
                                document.getElementById(inputId).value = newPath.trim();
                            }
                        }
                    } catch (e) {
                        console.error('Error opening folder dialog:', e);
                        var currentValue = document.getElementById(inputId).value;
                        var newPath = prompt(headerText + '\nAktueller Pfad: ' + currentValue, currentValue);
                        if (newPath !== null && newPath.trim() !== '') {
                            document.getElementById(inputId).value = newPath.trim();
                        }
                    }
                }

                function genUUID() {
                    try {
                        return crypto.randomUUID();
                    } catch (e) {
                        console.error('Error generating UUID using crypto.randomUUID():', e);
                    }
                    console.warn('Falling back to manual UUID generation.');
                    // Fallback method, this is not cryptographically secure but sufficient for our use case
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                        var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }

                function applySubscriptionDependencies() {
                    subscriptionDependencyRules.forEach(rule => {
                        const controller = document.getElementById(rule.controllerId);
                        const dependentContainer = document.getElementById(rule.dependentId);

                        if (controller && dependentContainer) {
                            const shouldShow = controller.checked === rule.showWhen;
                            dependentContainer.style.display = shouldShow ? 'block' : 'none';

                            if (rule.disableWhenHidden && !shouldShow) {
                                const dependentInput = dependentContainer.querySelector('input[type="checkbox"]');
                                if (dependentInput) {
                                    dependentInput.checked = false;
                                }
                            }
                        }
                    });
                }

                // --- Core Logic ---
                function loadConfig() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                        currentConfig = config;

                        document.querySelector('#txtDefaultDownloadPath').value = config.DefaultDownloadPath || "";
                        document.querySelector('#chkDownloadSubtitles').checked = config.DownloadSubtitles;
                        document.querySelector('#chkAllowUnknownDomains').checked = config.AllowUnknownDomains;
                        document.querySelector('#txtMinFreeDiskSpaceMiB').value = config.MinFreeDiskSpaceBytes ? (config.MinFreeDiskSpaceBytes / (1024 * 1024)) : "";
                        document.querySelector('#lblLastRun').innerText = config.LastRun ? new Date(config.LastRun).toLocaleString() : "Noch nie";

                        renderSubscriptionsList();

                        Dashboard.hideLoadingMsg();
                    });
                }

                function saveGlobalConfig() {
                    Dashboard.showLoadingMsg();
                    ApiClient.updatePluginConfiguration(pluginId, currentConfig).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                        showToast("Einstellungen gespeichert.");
                        loadConfig();
                    });
                }

                function switchTab(tabId) {
                    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
                    document.getElementById('tab-' + tabId).style.display = 'block';

                    const buttons = document.querySelectorAll('.sectionTabs button');
                    buttons.forEach(btn => btn.classList.remove('selected'));

                    if (tabId === 'search') buttons[0].classList.add('selected');
                    if (tabId === 'settings') buttons[1].classList.add('selected');
                    if (tabId === 'subscriptions') buttons[2].classList.add('selected');
                }

                // --- SEARCH LOGIC ---
                function performSearch() {
                    const query = document.getElementById('txtSearchQuery').value;
                    const minD = document.getElementById('numMinDuration').value;
                    const maxD = document.getElementById('numMaxDuration').value;

                    if (!query) {
                        showToast("Bitte Suchbegriff eingeben");
                        return;
                    }

                    Dashboard.showLoadingMsg();
                    let url = ApiClient.getUrl('/' + pluginName + '/Search');
                    url += '?query=' + encodeURIComponent(query);
                    if (minD) url += '&minDuration=' + minD;
                    if (maxD) url += '&maxDuration=' + maxD;

                    ApiClient.getJSON(url).then(function (results) {
                        currentSearchResults = results; // Store results
                        renderSearchResults();
                        Dashboard.hideLoadingMsg();
                    }).catch(function (err) {
                        Dashboard.hideLoadingMsg();
                        showToast("Fehler bei der Suche: " + err);
                    });
                }

                function renderSearchResults() {
                    const container = document.getElementById('searchResults');
                    container.innerHTML = "";

                    if (!currentSearchResults || currentSearchResults.length === 0) {
                        container.innerHTML = "<p>Keine Ergebnisse gefunden.</p>";
                        return;
                    }

                    let html = '<div class="paperList">';
                    currentSearchResults.forEach(function (item, index) {
                        const durationStr = Math.floor(item.duration / 60) + " Min";
                        const safeTitle = item.title.replace(/"/g, '&quot;');
                        const safeChannel = item.channel.replace(/"/g, '&quot;');
                        const safeTopic = item.topic.replace(/"/g, '&quot;');

                        html +=
                            '<div class="listItem listItem-border">' +
                            '<div class="listItemBody two-line">' +
                            '<h3 class="listItemBodyText">' + item.title + '</h3>' +
                            '<div class="listItemBodyText secondary" style="display: inline-flex; align-items: center; gap: 8px;"><span>' + item.channel + ' | ' + item.topic + ' | ' + durationStr + (item.url_subtitle ? ' | </span><span class="material-icons closed_caption" title="Untertitel verfügbar"></span>' : '</span>') + '</div>' +
                            '<div class="listItemBodyText secondary" style="font-size:0.9em; opacity:0.7;">' + (item.description ? item.description : '') + '</div>' +
                            '</div>' +
                            '<div style="display:flex; gap: 10px;">' +
                            // Download-Button
                            '<button is="emby-button" type="button" class="paper-icon-button-light" title="Herunterladen" onclick="MediathekPluginConfig.downloadItem(' + index + ')">' +
                            '<span class="material-icons file_download"></span>' +
                            '</button>' +
                            // Advanced Download-Button
                            '<button is="emby-button" type="button" class="paper-icon-button-light" title="Erweiterter Download" onclick="MediathekPluginConfig.openAdvancedDownloadDialog(' + index + ')">' +
                            '<span class="material-icons settings"></span>' +
                            '</button>' +
                            // Abo erstellen Button
                            '<button is="emby-button" type="button" class="paper-icon-button-light" title="Abo erstellen" onclick="MediathekPluginConfig.createSubFromSearch(this, \'' + safeTitle + '\', \'' + safeChannel + '\', \'' + safeTopic + '\')">' +
                            '<span class="material-icons add"></span>' +
                            '</button>' +
                            '</div>' +
                            '</div>';
                    });
                    html += '</div>';
                    container.innerHTML = html;
                }

                function downloadItem(index) {
                    const item = currentSearchResults[index];
                    if (!item) return;

                    const url = ApiClient.getUrl('/' + pluginName + '/Download');

                    Dashboard.showLoadingMsg();
                    ApiClient.ajax({
                        type: "POST",
                        url: url,
                        data: JSON.stringify(item),
                        contentType: 'application/json'
                    }).then(function (result) {
                        Dashboard.hideLoadingMsg();
                        showToast("Download für '" + item.title + "' gestartet.");
                    }).catch(function (err) {
                        Dashboard.hideLoadingMsg();
                        showToast("Fehler beim Starten des Downloads: " + (err.responseJSON ? err.responseJSON.detail : "Unbekannter Fehler"));
                    });
                }

                function createSubFromSearch(btn, title, channel, topic) {
                    switchTab('subscriptions');
                    const newSub = {
                        Id: null,
                        Name: topic,
                        Queries: [
                            { fields: ["title"], query: title },
                            { fields: ["channel"], query: channel },
                            { fields: ["topic"], query: topic }
                        ],
                        MinDurationMinutes: null,
                        MaxDurationMinutes: null,
                        DownloadPath: "",
                        EnforceSeriesParsing: false,
                        AllowAudioDescription: false
                    };
                    editSubscription(null, newSub);
                }


                // --- SUBSCRIPTION LOGIC ---
                function renderSubscriptionsList() {
                    const list = document.getElementById('subscriptionList');
                    list.innerHTML = "";

                    if (!currentConfig.Subscriptions || currentConfig.Subscriptions.length === 0) {
                        list.innerHTML = "<p>Keine aktiven Abonnements.</p>";
                        return;
                    }

                    let html = '';
                    currentConfig.Subscriptions.forEach(function (sub) {
                        const queriesSummary = (sub.Queries || []).map(function (q) { return q.query; }).join(', ');
                        html +=
                            '<div class="listItem listItem-border">' +
                            '<div class="listItemBody two-line">' +
                            '<h3 class="listItemBodyText">' + sub.Name + '</h3>' +
                            '<div class="listItemBodyText secondary">Queries: ' + queriesSummary + '</div>' +
                            '</div>' +
                            '<div style="display:flex; gap:5px;">' +
                            '<button type="button" class="paper-icon-button-light" onclick="MediathekPluginConfig.editSubscription(\'' + sub.Id + '\', null)" title="Bearbeiten">' +
                            '<span class="material-icons edit"></span>' +
                            '</button>' +
                            '<button type="button" class="paper-icon-button-light" onclick="MediathekPluginConfig.deleteSubscription(\'' + sub.Id + '\')" title="Löschen">' +
                            '<span class="material-icons delete"></span>' +
                            '</button>' +
                            '</div>' +
                            '</div>';
                    });
                    list.innerHTML = html;
                }

                function addQueryRow(query) {
                    if (query == null) {
                        query = { query: '', fields: ['title', 'topic'] };
                    }
                    const container = document.getElementById('queriesContainer');
                    const newRow = document.createElement('div');
                    newRow.className = 'query-row';
                    newRow.style.cssText = 'display: flex; gap: 10px; align-items: center; border: 1px solid #333; padding: 10px; border-radius: 5px;';

                    const queryText = query ? query.query : '';
                    const fields = query ? query.fields : ['title', 'topic'];

                    var checkedTitle = fields.indexOf('title') > -1 ? 'checked' : '';
                    var checkedTopic = fields.indexOf('topic') > -1 ? 'checked' : '';
                    var checkedChannel = fields.indexOf('channel') > -1 ? 'checked' : '';

                    newRow.innerHTML =
                        '<div style="flex-grow: 1;">' +
                        '<input is="emby-input" type="text" class="subQueryText" value="' + queryText + '" placeholder="Suchtext" required />' +
                        '</div>' +
                        '<div style="display: flex; gap: 15px;">' +
                        '<label class="emby-checkbox-label"><input type="checkbox" is="emby-checkbox" class="subQueryField" value="title" ' + checkedTitle + '><span>Titel</span></label>' +
                        '<label class="emby-checkbox-label"><input type="checkbox" is="emby-checkbox" class="subQueryField" value="topic" ' + checkedTopic + '><span>Thema</span></label>' +
                        '<label class="emby-checkbox-label"><input type="checkbox" is="emby-checkbox" class="subQueryField" value="channel" ' + checkedChannel + '><span>Sender</span></label>' +
                        '</div>' +
                        '<button type="button" is="paper-icon-button-light" class="btnRemoveQuery" title="Anfrage entfernen">' +
                        '<span class="material-icons remove_circle_outline"></span>' +
                        '</button>';

                    container.appendChild(newRow);

                    newRow.querySelector('.btnRemoveQuery').addEventListener('click', function () {
                        this.closest('.query-row').remove();
                    });
                }

                function editSubscription(id, prefilledSub) {
                    const editor = document.getElementById('subscriptionEditor');
                    const title = document.getElementById('subEditorTitle');
                    const queriesContainer = document.getElementById('queriesContainer');

                    document.getElementById('subId').value = "";
                    document.getElementById('subName').value = "";
                    document.getElementById('subMinDuration').value = "";
                    document.getElementById('subMaxDuration').value = "";
                    document.getElementById('subPath').value = "";
                    document.getElementById('subEnforceSeries').checked = false;
                    document.getElementById('subAllowAudioDesc').checked = false;
                    document.getElementById('subAllowAbsoluteEpisodeNumbering').checked = false;
                    document.getElementById('subAllowSignLanguage').checked = false;
                    document.getElementById('subTreatNonEpisodesAsExtras').checked = false;
                    document.getElementById('subUseStreamingUrlFiles').checked = false;
                    queriesContainer.innerHTML = '';

                    let subToEdit = null;
                    if (id) {
                        subToEdit = currentConfig.Subscriptions.find(function (s) { return s.Id === id; });
                        title.innerText = "Abonnement bearbeiten";
                    } else if (prefilledSub) {
                        subToEdit = prefilledSub;
                        title.innerText = "Neues Abonnement erstellen";
                    } else {
                        title.innerText = "Neues Abonnement";
                    }

                    if (subToEdit) {
                        document.getElementById('subId').value = subToEdit.Id || "";
                        document.getElementById('subName').value = subToEdit.Name;
                        document.getElementById('subMinDuration').value = subToEdit.MinDurationMinutes || "";
                        document.getElementById('subMaxDuration').value = subToEdit.MaxDurationMinutes || "";
                        document.getElementById('subPath').value = subToEdit.DownloadPath || "";
                        document.getElementById('subEnforceSeries').checked = subToEdit.EnforceSeriesParsing;
                        document.getElementById('subAllowAudioDesc').checked = subToEdit.AllowAudioDescription;
                        document.getElementById('subAllowAbsoluteEpisodeNumbering').checked = subToEdit.AllowAbsoluteEpisodeNumbering;
                        document.getElementById('subAllowSignLanguage').checked = subToEdit.AllowSignLanguage;
                        document.getElementById('subTreatNonEpisodesAsExtras').checked = subToEdit.TreatNonEpisodesAsExtras;
                        document.getElementById('subUseStreamingUrlFiles').checked = subToEdit.UseStreamingUrlFiles;

                        if (subToEdit.Queries && subToEdit.Queries.length > 0) {
                            subToEdit.Queries.forEach(function (q) { addQueryRow(q); });
                        } else {
                            addQueryRow(null);
                        }
                    } else {
                        addQueryRow(null);
                    }

                    applySubscriptionDependencies();

                    editor.style.display = 'block';
                    editor.scrollIntoView({ behavior: 'smooth' });
                }

                function closeEditor() {
                    document.getElementById('subscriptionEditor').style.display = 'none';
                }

                function saveSubscription() {
                    const id = document.getElementById('subId').value;
                    const name = document.getElementById('subName').value;
                    const minDuration = document.getElementById('subMinDuration').value;
                    const maxDuration = document.getElementById('subMaxDuration').value;
                    const path = document.getElementById('subPath').value;
                    const enforce = document.getElementById('subEnforceSeries').checked;
                    const allowAudio = document.getElementById('subAllowAudioDesc').checked;
                    const allowAbsolute = document.getElementById('subAllowAbsoluteEpisodeNumbering').checked;
                    const allowSignLanguage = document.getElementById('subAllowSignLanguage').checked;
                    const treatNonEpisodesAsExtras = document.getElementById('subTreatNonEpisodesAsExtras').checked;
                    const useStreamingUrlFiles = document.getElementById('subUseStreamingUrlFiles').checked;

                    const queries = [];
                    document.querySelectorAll('#queriesContainer .query-row').forEach(function (row) {
                        const queryText = row.querySelector('.subQueryText').value;
                        if (queryText) {
                            const fields = [];
                            row.querySelectorAll('.subQueryField:checked').forEach(function (fieldCheckbox) {
                                fields.push(fieldCheckbox.value);
                            });
                            queries.push({ query: queryText, fields: fields });
                        }
                    });

                    if (queries.length === 0) {
                        showToast("Bitte mindestens eine Suchanfrage definieren.");
                        return;
                    }

                    if (!currentConfig.Subscriptions) currentConfig.Subscriptions = [];

                    const subData = {
                        Name: name,
                        Queries: queries,
                        MinDurationMinutes: minDuration ? parseInt(minDuration, 10) : null,
                        MaxDurationMinutes: maxDuration ? parseInt(maxDuration, 10) : null,
                        DownloadPath: path,
                        EnforceSeriesParsing: enforce,
                        AllowAudioDescription: allowAudio,
                        AllowAbsoluteEpisodeNumbering: allowAbsolute,
                        AllowSignLanguage: allowSignLanguage,
                        TreatNonEpisodesAsExtras: treatNonEpisodesAsExtras,
                        UseStreamingUrlFiles: useStreamingUrlFiles
                    };

                    if (id) {
                        const idx = currentConfig.Subscriptions.findIndex(function (s) { return s.Id === id; });
                        if (idx > -1) {
                            var existingId = currentConfig.Subscriptions[idx].Id;
                            currentConfig.Subscriptions[idx] = subData;
                            currentConfig.Subscriptions[idx].Id = existingId;

                        }
                    } else {
                        subData.Id = genUUID();
                        currentConfig.Subscriptions.push(subData);
                    }

                    saveGlobalConfig();
                    closeEditor();
                    renderSubscriptionsList();
                }

                function deleteSubscription(id) {
                    confirmationPopup("Soll dieses Abonnement wirklich gelöscht werden?", "Löschen bestätigen", function (confirmed) {
                        if (confirmed) {
                            currentConfig.Subscriptions = currentConfig.Subscriptions.filter(function (s) { return s.Id !== id; });
                            saveGlobalConfig();
                            renderSubscriptionsList();
                        }
                    });
                }

                function openAdvancedDownloadDialog(index) {
                    currentItemForAdvancedDl = currentSearchResults[index];
                    if (!currentItemForAdvancedDl) return;

                    document.getElementById('advancedDownloadTitle').innerText = 'Erweiterter Download: ' + currentItemForAdvancedDl.title;
                    document.getElementById('advancedDownloadIndex').value = index;

                    document.getElementById('advDlPath').value = currentConfig.DefaultDownloadPath || '';

                    let proposedFilename = (currentItemForAdvancedDl.topic || 'video') + " - " + (currentItemForAdvancedDl.title || 'video');
                    proposedFilename = proposedFilename.replace(/[\/\\?%*:|"<>]/g, '-') + '.mp4';
                    document.getElementById('advDlFilename').value = proposedFilename;


                    document.getElementById('advDlSubtitles').checked = currentConfig.DownloadSubtitles && currentItemForAdvancedDl.url_subtitle;
                    document.getElementById('advDlSubtitles').disabled = !currentItemForAdvancedDl.url_subtitle;


                    document.getElementById('advancedDownloadModal').style.display = 'flex';
                }

                function closeAdvancedDownloadDialog() {
                    document.getElementById('advancedDownloadModal').style.display = 'none';
                }

                function performAdvancedDownload() {
                    if (!currentItemForAdvancedDl) return;

                    const downloadOptions = {
                        item: currentItemForAdvancedDl,
                        downloadPath: document.getElementById('advDlPath').value,
                        fileName: document.getElementById('advDlFilename').value,
                        downloadSubtitles: document.getElementById('advDlSubtitles').checked
                    };

                    const url = ApiClient.getUrl('/' + pluginName + '/AdvancedDownload');

                    Dashboard.showLoadingMsg();
                    ApiClient.ajax({
                        type: "POST",
                        url: url,
                        data: JSON.stringify(downloadOptions),
                        contentType: 'application/json'
                    }).then(function (result) {
                        Dashboard.hideLoadingMsg();
                        closeAdvancedDownloadDialog();
                        showToast("Download für '" + currentItemForAdvancedDl.title + "' gestartet.");
                    }).catch(function (err) {
                        Dashboard.hideLoadingMsg();
                        showToast("Fehler beim Starten des Downloads: " + (err.responseJSON ? err.responseJSON.detail : "Unbekannter Fehler"));
                    });
                }

                // --- EVENT LISTENERS ---
                return {
                    init: function () {
                        document.querySelector('#MediathekViewDLConfigPage').addEventListener('pageshow', function () {
                            loadConfig();
                        });

                        document.querySelector('#MediathekGeneralConfigForm').addEventListener('submit', function (e) {
                            e.preventDefault();
                            currentConfig.DefaultDownloadPath = document.querySelector('#txtDefaultDownloadPath').value;
                            currentConfig.DownloadSubtitles = document.querySelector('#chkDownloadSubtitles').checked;
                            currentConfig.AllowUnknownDomains = document.querySelector('#chkAllowUnknownDomains').checked;
                            const minFreeSpaceMiB = parseInt(document.querySelector('#txtMinFreeDiskSpaceMiB').value, 10);
                            currentConfig.MinFreeDiskSpaceBytes = isNaN(minFreeSpaceMiB) ? (1.5 * 1024 * 1024 * 1024) : (minFreeSpaceMiB * 1024 * 1024);
                            saveGlobalConfig();
                            return false;
                        });

                        document.getElementById('btnSelectPath').addEventListener('click', function () {
                            openFolderDialog('txtDefaultDownloadPath', 'Standard Download Pfad wählen');
                        });

                        document.getElementById('btnSelectSubPath').addEventListener('click', function () {
                            openFolderDialog('subPath', 'Abo Pfad wählen');
                        });

                        document.getElementById('btnSelectAdvPath').addEventListener('click', function () {
                            openFolderDialog('advDlPath', 'Download Pfad wählen');
                        });

                        const controllerIds = [...new Set(subscriptionDependencyRules.map(rule => rule.controllerId))];
                        controllerIds.forEach(id => {
                            const controller = document.getElementById(id);
                            if (controller) {
                                controller.addEventListener('change', applySubscriptionDependencies);
                            }
                        });
                    },
                    switchTab: switchTab,
                    performSearch: performSearch,
                    createSubFromSearch: createSubFromSearch,
                    downloadItem: downloadItem,
                    openAdvancedDownloadDialog: openAdvancedDownloadDialog,
                    closeAdvancedDownloadDialog: closeAdvancedDownloadDialog,
                    performAdvancedDownload: performAdvancedDownload,
                    addQueryRow: addQueryRow,
                    editSubscription: editSubscription,
                    closeEditor: closeEditor,
                    saveSubscription: saveSubscription,
                    deleteSubscription: deleteSubscription,
                    openFolderDialog: openFolderDialog
                };
            })();

            MediathekPluginConfig.init();
        </script>

        <style>
            .tabs-spacer {
                margin-bottom: 20px;
                border-bottom: 1px solid #333;
            }

            .sectionTabs button.selected {
                color: #00a4dc;
                border-bottom: 2px solid #00a4dc;
            }

            .listItemBodyText.secondary {
                color: #aaa;
            }
        </style>
    </div>
</body>

</html>
