<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <title>MediathekView Plugin Konfiguration</title>
</head>
<body>
    <div id="MediathekViewDLConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
         data-require="emby-input,emby-button,emby-select,emby-checkbox,emby-linkbutton">

        <div data-role="content">
            <div class="content-primary">

                <!-- Tab Navigation -->
                <div class="sectionTabs tabs-spacer">
                    <button type="button" class="paper-icon-button-light selected" onclick="MediathekPluginConfig.switchTab('search')">
                        <span class="material-icons search" aria-hidden="true"></span>
                        <span>Manuelle Suche</span>
                    </button>
                    <button type="button" class="paper-icon-button-light" onclick="MediathekPluginConfig.switchTab('settings')">
                        <span class="material-icons settings" aria-hidden="true"></span>
                        <span>Einstellungen</span>
                    </button>
                    <button type="button" class="paper-icon-button-light" onclick="MediathekPluginConfig.switchTab('subscriptions')">
                        <span class="material-icons subscriptions" aria-hidden="true"></span>
                        <span>Abo Verwaltung</span>
                    </button>
                </div>

                <!-- TAB 1: SUCHE -->
                <div id="tab-search" class="tab-content" style="display:block;">
                    <div class="verticalSection">
                        <div class="sectionTitleLabel">Mediathek durchsuchen</div>
                        <p class="sectionDescription">Suche nach Inhalten, um diese direkt herunterzuladen oder ein Abo zu erstellen.</p>

                        <form onsubmit="MediathekPluginConfig.performSearch(); return false;">
                            <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                                <div class="inputContainer" style="flex-grow: 1;">
                                    <label class="inputLabel" for="txtSearchQuery">Suchbegriff</label>
                                    <input is="emby-input" type="text" id="txtSearchQuery" required />
                                </div>
                                <div class="inputContainer" style="width: 150px;">
                                    <label class="inputLabel" for="numMinDuration">Min. Dauer (Sek)</label>
                                    <input is="emby-input" type="number" id="numMinDuration" />
                                </div>
                                <div class="inputContainer" style="width: 150px;">
                                    <label class="inputLabel" for="numMaxDuration">Max. Dauer (Sek)</label>
                                    <input is="emby-input" type="number" id="numMaxDuration" />
                                </div>
                                <div class="inputContainer">
                                    <button is="emby-button" type="submit" class="raised button-submit block">
                                        <span>Suchen</span>
                                    </button>
                                </div>
                            </div>
                        </form>

                        <div id="searchResults" style="margin-top: 20px;">
                            <!-- Ergebnisse werden hier gerendert -->
                        </div>
                    </div>
                </div>

                <!-- TAB 2: EINSTELLUNGEN -->
                <div id="tab-settings" class="tab-content" style="display:none;">
                    <div class="verticalSection">
                        <div class="sectionTitleLabel">Allgemeine Einstellungen</div>
                        <form id="MediathekGeneralConfigForm">

                            <div class="inputContainer">
                                <div style="display: flex; align-items: center;">
                                    <div style="flex-grow: 1;">
                                        <label class="inputLabel" for="txtDefaultDownloadPath">Standard Download Pfad</label>
                                        <input is="emby-input" type="text" id="txtDefaultDownloadPath" />
                                        <div class="fieldDescription">Der Standard-Ordner für alle Downloads, sofern im Abo nichts anderes definiert ist.</div>
                                    </div>
                                    <button type="button" is="paper-icon-button-light" id="btnSelectPath" title="Ordner auswählen" style="margin-left: 10px; margin-top: 15px;">
                                        <span class="material-icons folder_open"></span>
                                    </button>
                                </div>
                            </div>

                            <!-- Anzeige des letzten Laufs (Read Only) -->
                            <div class="inputContainer">
                                <label class="inputLabel">Letzter Lauf</label>
                                <div id="lblLastRun" style="padding: 10px 0;">Noch nie</div>
                            </div>

                            <div>
                                <button is="emby-button" type="submit" class="raised button-submit block">
                                    <span>Speichern</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- TAB 3: ABO VERWALTUNG -->
                <div id="tab-subscriptions" class="tab-content" style="display:none;">
                    <div class="verticalSection">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="sectionTitleLabel">Aktive Abonnements</div>
                            <button is="emby-button" type="button" class="raised" onclick="MediathekPluginConfig.editSubscription(null)">
                                <span class="material-icons add"></span>
                                <span>Neues Abo</span>
                            </button>
                        </div>
                        <div id="subscriptionList" class="paperList" style="margin-top: 20px;">
                            <!-- Liste wird hier gerendert -->
                        </div>
                    </div>

                    <!-- Modal/Bereich zum Editieren eines Abos (Initial versteckt) -->
                    <div id="subscriptionEditor" style="display: none; border-top: 1px solid #444; margin-top: 20px; padding-top: 20px;">
                        <h3 id="subEditorTitle">Abonnement bearbeiten</h3>
                        <form onsubmit="MediathekPluginConfig.saveSubscription(); return false;">
                            <input type="hidden" id="subId" />

                            <div class="inputContainer">
                                <label class="inputLabel" for="subName">Name (Serienname)</label>
                                <input is="emby-input" type="text" id="subName" required />
                            </div>

                            <div class="inputContainer">
                                <label class="inputLabel" for="subQuery">Suchbegriff (Query)</label>
                                <input is="emby-input" type="text" id="subQuery" required />
                            </div>

                            <div class="inputContainer">
                                <div style="display: flex; align-items: center;">
                                    <div style="flex-grow: 1;">
                                        <label class="inputLabel" for="subPath">Download Pfad (Optional)</label>
                                        <input is="emby-input" type="text" id="subPath" />
                                        <div class="fieldDescription">Leer lassen, um den Standardpfad zu nutzen.</div>
                                    </div>
                                    <!-- Button hat nun eine ID für den Event Listener -->
                                    <button type="button" is="paper-icon-button-light" id="btnSelectSubPath" title="Ordner auswählen" style="margin-left: 10px; margin-top: 15px;">
                                        <span class="material-icons folder_open"></span>
                                    </button>
                                </div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="subEnforceSeries" type="checkbox" is="emby-checkbox" />
                                    <span>Nur Episoden mit Staffel/Folgen-Nummer herunterladen</span>
                                </label>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="subAllowAudioDesc" type="checkbox" is="emby-checkbox" />
                                    <span>Versionen mit Audiodeskription erlauben</span>
                                </label>
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <button is="emby-button" type="submit" class="raised button-submit">
                                    <span>Abo Speichern</span>
                                </button>
                                <button is="emby-button" type="button" class="raised button-cancel" onclick="MediathekPluginConfig.closeEditor()">
                                    <span>Abbrechen</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
        </div>

        <script type="text/javascript">
            var MediathekPluginConfig = (function() {

                const pluginId = "a31b415a-5264-419d-b152-8c8192a54994";
                const pluginName = "MediathekViewDL";
                let currentConfig = null;

                // --- Helper Functions ---
                function confirmationPopup(message, title, resultCallback) {
                    if (typeof Dashboard !== 'undefined' && typeof Dashboard.confirm === 'function') {
                        Dashboard.confirm(message, title, resultCallback);
                    } else {
                        const result = confirm(title + "\n\n" + message);
                        resultCallback(result);
                    }
                }

                function showToast(message) {
                    if (typeof Dashboard !== 'undefined' && typeof Dashboard.alert === 'function') {
                        Dashboard.alert(message);
                    } else {
                        alert(message);
                    }
                }

                function openFolderDialog(inputId, headerText) {
                    try {
                        if (typeof Dashboard !== 'undefined' && Dashboard.DirectoryBrowser) {
                            const picker = new Dashboard.DirectoryBrowser();
                            picker.show({
                                header: headerText,
                                includeDirectories: true,
                                includeFiles: false,
                                callback: function (path) {
                                    if (path) {
                                        document.getElementById(inputId).value = path;
                                    }
                                    picker.close();
                                }
                            });
                        } else {
                            // Fallback wenn Dashboard nicht verfügbar ist
                            var currentValue = document.getElementById(inputId).value;
                            var newPath = prompt(headerText + '\nAktueller Pfad: ' + currentValue, currentValue);
                            if (newPath !== null && newPath.trim() !== '') {
                                document.getElementById(inputId).value = newPath.trim();
                            }
                        }
                    } catch (e) {
                        console.error('Error opening folder dialog:', e);
                        // Fallback
                        var currentValue = document.getElementById(inputId).value;
                        var newPath = prompt(headerText + '\nAktueller Pfad: ' + currentValue, currentValue);
                        if (newPath !== null && newPath.trim() !== '') {
                            document.getElementById(inputId).value = newPath.trim();
                        }
                    }
                }

                // --- Core Logic ---

                function loadConfig() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                        currentConfig = config;

                        // Tab 2: Settings populate
                        document.querySelector('#txtDefaultDownloadPath').value = config.DefaultDownloadPath || "";
                        document.querySelector('#lblLastRun').innerText = config.LastRun ? new Date(config.LastRun).toLocaleString() : "Noch nie";

                        // Tab 3: Subscriptions populate
                        renderSubscriptionsList();

                        Dashboard.hideLoadingMsg();
                    });
                }

                function saveGlobalConfig() {
                    Dashboard.showLoadingMsg();
                    ApiClient.updatePluginConfiguration(pluginId, currentConfig).then(function (result) {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                        showToast("Einstellungen gespeichert.");
                        loadConfig();
                    });
                }

                function switchTab(tabId) {
                    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
                    document.getElementById('tab-' + tabId).style.display = 'block';

                    const buttons = document.querySelectorAll('.sectionTabs button');
                    buttons.forEach(btn => btn.classList.remove('selected'));

                    if(tabId === 'search') buttons[0].classList.add('selected');
                    if(tabId === 'settings') buttons[1].classList.add('selected');
                    if(tabId === 'subscriptions') buttons[2].classList.add('selected');
                }

                // --- SEARCH LOGIC ---

                function performSearch() {
                    const query = document.getElementById('txtSearchQuery').value;
                    const minD = document.getElementById('numMinDuration').value;
                    const maxD = document.getElementById('numMaxDuration').value;

                    if (!query) {
                        showToast("Bitte Suchbegriff eingeben");
                        return;
                    }

                    Dashboard.showLoadingMsg();

                    let url = ApiClient.getUrl('/' + pluginName + '/Search'); // `/${pluginName}/Search` is not used because it intrudes issues with tranlation in Jellyfin
                    url += '?query=' + encodeURIComponent(query);
                    if(minD) url += '&minDuration=' + minD;
                    if(maxD) url += '&maxDuration=' + maxD;

                    ApiClient.getJSON(url).then(function(results) {
                        renderSearchResults(results);
                        Dashboard.hideLoadingMsg();
                    }).catch(function(err) {
                        Dashboard.hideLoadingMsg();
                        showToast("Fehler bei der Suche: " + err);
                    });
                }

                function renderSearchResults(items) {
                    const container = document.getElementById('searchResults');
                    container.innerHTML = "";

                    if (!items || items.length === 0) {
                        container.innerHTML = "<p>Keine Ergebnisse gefunden.</p>";
                        return;
                    }

                    let html = '<div class="list-group">';
                    items.forEach(item => {
                        const durationStr = Math.floor(item.duration / 60) + " Min";
                        const safeTitle = item.title.replace(/"/g, '&quot;');
                        const safeChannel = item.channel.replace(/"/g, '&quot;');

                        html += `
                        <div class="listItem listItem-border">
                            <div class="listItemBody two-line">
                                <h3 class="listItemBodyText">` + item.title + `</h3>
                                <div class="listItemBodyText secondary">` + item.channel + ` | ` + item.topic + ` | ` + durationStr + `</div>
                                <div class="listItemBodyText secondary" style="font-size:0.9em; opacity:0.7;">` + (item.description ? item.description : '') + `</div>
                            </div>
                            <button class="fab emby-button" title="Abo erstellen" onclick="MediathekPluginConfig.createSubFromSearch('`+ safeTitle + `', '` + safeChannel +`')">
                                <span class="material-icons add"></span>
                            </button>
                        </div>`;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                }

                function createSubFromSearch(title, channel) {
                    switchTab('subscriptions');
                    editSubscription(null);
                    document.getElementById('subName').value = title;
                    document.getElementById('subQuery').value = channel + " " + title;
                }

                // --- SUBSCRIPTION LOGIC ---

                function renderSubscriptionsList() {
                    const list = document.getElementById('subscriptionList');
                    list.innerHTML = "";

                    if (!currentConfig.Subscriptions || currentConfig.Subscriptions.length === 0) {
                        list.innerHTML = "<p>Keine aktiven Abonnements.</p>";
                        return;
                    }

                    let html = '';
                    currentConfig.Subscriptions.forEach(sub => {
                        html += `
                        <div class="listItem listItem-border">
                            <div class="listItemBody two-line">
                                <h3 class="listItemBodyText">` + sub.Name + `</h3>
                                <div class="listItemBodyText secondary">Query: ` + sub.SearchQuery + `</div>
                            </div>
                            <div style="display:flex; gap:5px;">
                                <button type="button" class="paper-icon-button-light" onclick="MediathekPluginConfig.editSubscription('` + sub.Id + `')" title="Bearbeiten">
                                    <span class="material-icons edit"></span>
                                </button>
                                <button type="button" class="paper-icon-button-light" onclick="MediathekPluginConfig.deleteSubscription('` + sub.Id + `')" title="Löschen">
                                    <span class="material-icons delete"></span>
                                </button>
                            </div>
                        </div>`;
                    });
                    list.innerHTML = html;
                }

                function editSubscription(id) {
                    const editor = document.getElementById('subscriptionEditor');
                    const title = document.getElementById('subEditorTitle');

                    document.getElementById('subId').value = "";
                    document.getElementById('subName').value = "";
                    document.getElementById('subQuery').value = "";
                    document.getElementById('subPath').value = "";
                    document.getElementById('subEnforceSeries').checked = false;
                    document.getElementById('subAllowAudioDesc').checked = false;

                    if (id) {
                        const sub = currentConfig.Subscriptions.find(s => s.Id === id);
                        if (sub) {
                            title.innerText = "Abonnement bearbeiten";
                            document.getElementById('subId').value = sub.Id;
                            document.getElementById('subName').value = sub.Name;
                            document.getElementById('subQuery').value = sub.SearchQuery;
                            document.getElementById('subPath').value = sub.DownloadPath || "";
                            document.getElementById('subEnforceSeries').checked = sub.EnforceSeriesParsing;
                            document.getElementById('subAllowAudioDesc').checked = sub.AllowAudioDescription;
                        }
                    } else {
                        title.innerText = "Neues Abonnement";
                    }

                    editor.style.display = 'block';
                    editor.scrollIntoView({ behavior: 'smooth' });
                }

                function closeEditor() {
                    document.getElementById('subscriptionEditor').style.display = 'none';
                }

                function saveSubscription() {
                    const id = document.getElementById('subId').value;
                    const name = document.getElementById('subName').value;
                    const query = document.getElementById('subQuery').value;
                    const path = document.getElementById('subPath').value;
                    const enforce = document.getElementById('subEnforceSeries').checked;
                    const allowAudio = document.getElementById('subAllowAudioDesc').checked;

                    if (!currentConfig.Subscriptions) currentConfig.Subscriptions = [];

                    if (id) {
                        const idx = currentConfig.Subscriptions.findIndex(s => s.Id === id);
                        if (idx > -1) {
                            currentConfig.Subscriptions[idx].Name = name;
                            currentConfig.Subscriptions[idx].SearchQuery = query;
                            currentConfig.Subscriptions[idx].DownloadPath = path;
                            currentConfig.Subscriptions[idx].EnforceSeriesParsing = enforce;
                            currentConfig.Subscriptions[idx].AllowAudioDescription = allowAudio;
                        }
                    } else {
                        const newSub = {
                            Id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
                            Name: name,
                            SearchQuery: query,
                            DownloadPath: path,
                            EnforceSeriesParsing: enforce,
                            AllowAudioDescription: allowAudio
                        };
                        currentConfig.Subscriptions.push(newSub);
                    }

                    saveGlobalConfig();
                    closeEditor();
                    renderSubscriptionsList();
                }

                function deleteSubscription(id) {
                    confirmationPopup("Soll dieses Abonnement wirklich gelöscht werden?", "Löschen bestätigen", function(confirmed) {
                        if (confirmed) {
                            currentConfig.Subscriptions = currentConfig.Subscriptions.filter(s => s.Id !== id);
                            saveGlobalConfig();
                            renderSubscriptionsList();
                        }
                    });
                }

                // --- EVENT LISTENERS ---
                return {
                    init: function() {
                        console.log("MediathekViewDL Plugin Config started initialization.");
                        document.querySelector('#MediathekViewDLConfigPage').addEventListener('pageshow', function() {
                            loadConfig();
                        });

                        console.log("Adding event listener for General Config Form submission.");
                        document.querySelector('#MediathekGeneralConfigForm').addEventListener('submit', function(e) {
                            e.preventDefault();
                            currentConfig.DefaultDownloadPath = document.querySelector('#txtDefaultDownloadPath').value;
                            saveGlobalConfig();
                            return false;
                        });

                        console.log("Adding event listener for General Config Folder Selection button.");
                        document.getElementById('btnSelectPath').addEventListener('click', function() {
                            openFolderDialog('txtDefaultDownloadPath', 'Standard Download Pfad wählen');
                        });

                        console.log("Adding event listener for Subscription Config Folder Selection button.");
                        document.getElementById('btnSelectSubPath').addEventListener('click', function() {
                            openFolderDialog('subPath', 'Abo Pfad wählen');
                        });
                    },
                    switchTab: switchTab,
                    performSearch: performSearch,
                    createSubFromSearch: createSubFromSearch,
                    editSubscription: editSubscription,
                    closeEditor: closeEditor,
                    saveSubscription: saveSubscription,
                    deleteSubscription: deleteSubscription,
                    openFolderDialog: openFolderDialog
                };
            })();

            MediathekPluginConfig.init();
        </script>

        <style>
            .tabs-spacer {
                margin-bottom: 20px;
                border-bottom: 1px solid #333;
            }
            .sectionTabs button.selected {
                color: #00a4dc;
                border-bottom: 2px solid #00a4dc;
            }
            .listItemBodyText.secondary {
                color: #aaa;
            }
        </style>
    </div>
</body>
</html>
